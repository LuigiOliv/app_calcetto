<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcetto Rating App v3</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>	
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyC_81ukybf3QOFFvJcgDWMgbor4Z7k1bgI",
        authDomain: "calcetto-af1e0.firebaseapp.com",
        projectId: "calcetto-af1e0",
        storageBucket: "calcetto-af1e0.firebasestorage.app",
        messagingSenderId: "1035881443344",
        appId: "1:1035881443344:web:2690813dc00bce70d19a95"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
    </script>
</head>
<body>
    <div id="root">
        <div className="login-container">
            <div className="login-card">
                <h2>‚öΩ Caricamento...</h2>
                <p>Se rimani bloccato qui, prova a ricaricare la pagina</p>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const ADMIN_EMAIL = 'luigi.oliviero@gmail.com';

        const SKILLS = {
            tecniche: ['Tiro', 'Passaggio corto', 'Passaggio lungo', 'Contrasto', 'Controllo'],
            tattiche: ['Visione di gioco', 'Senso della posizione', 'Spirito di sacrificio', 'Letture difensive', 'Costruzione'],
            fisiche: ['Resistenza', 'Scatto', 'Progressione', 'Presenza fisica', 'Cazzimma']
        };

        const ROLES = [
            'Portiere', 'Difensore centrale', 'Difensore laterale sx', 'Difensore laterale dx',
            'Centrocampista difensivo', 'Centrocampista offensivo', 'Mezzala sx', 'Mezzala dx', 'Centravanti'
        ];

        const storage = {
            getUsers: async () => {
                const snapshot = await db.collection('users').get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            },
            setUsers: async (users) => {
                const batch = db.batch();
                users.forEach(user => {
                    const ref = db.collection('users').doc(user.id);
                    batch.set(ref, user);
                });
                await batch.commit();
            },
            updateUser: async (user) => {
                await db.collection('users').doc(user.id).set(user);
            },
            getVotes: async () => {
                const snapshot = await db.collection('votes').get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            },
            addVote: async (vote) => {
                await db.collection('votes').add(vote);
            },
            setVotes: async (votes) => {
                const batch = db.batch();
                votes.forEach((vote, index) => {
                    const ref = db.collection('votes').doc(`vote_${Date.now()}_${index}`);
                    batch.set(ref, vote);
                });
                await batch.commit();
            },
            getCurrentUser: () => JSON.parse(localStorage.getItem('calcetto_current_user') || 'null'),
            setCurrentUser: (user) => localStorage.setItem('calcetto_current_user', JSON.stringify(user)),
            clearAll: () => {
                localStorage.removeItem('calcetto_current_user');
            }
        };

        const utils = {
            calculateAverages: (playerId, votes) => {
                const playerVotes = votes.filter(v => v.playerId === playerId);
                if (playerVotes.length === 0) return null;
                const averages = {};
                const allSkills = [...SKILLS.tecniche, ...SKILLS.tattiche, ...SKILLS.fisiche];
                allSkills.forEach(skill => {
                    const values = playerVotes.map(v => v.ratings[skill]).filter(v => v !== undefined);
                    if (values.length > 0) {
                        averages[skill] = values.reduce((a, b) => a + b, 0) / values.length;
                    }
                });
                return averages;
            },
            calculateOverall: (averages) => {
                if (!averages) return null;
                const values = Object.values(averages);
                if (values.length === 0) return null;
                return values.reduce((a, b) => a + b, 0) / values.length;
            },
            calculateCategoryOverall: (averages, category) => {
                if (!averages) return null;
                const skills = SKILLS[category];
                const values = skills.map(s => averages[s]).filter(v => v !== undefined);
                if (values.length === 0) return null;
                return values.reduce((a, b) => a + b, 0) / values.length;
            },
            countVotes: (playerId, votes) => {
                return votes.filter(v => v.playerId === playerId).length;
            },
            toBase10: (value) => {
                return (value / 4) * 10;
            },
            getInitials: (name) => {
                return name.substring(0, 2).toUpperCase();
            }
        };

        function LoginPage({ onLogin }) {
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleGoogleLogin = () => {
                setLoading(true);
                setError('');
                const provider = new firebase.auth.GoogleAuthProvider();
                firebase.auth().signInWithPopup(provider)
                    .then((result) => { onLogin(result.user.email); })
                    .catch((err) => {
                        console.error(err);
                        setError('Errore: ' + err.message);
                        setLoading(false);
                    });
            };

            return (
                <div className="login-container">
                    <div className="login-card">
                        <h1>‚öΩ Calcetto Rating</h1>
                        <p>Valuta i tuoi compagni di squadra</p>
                        {error && <p className="error-message">{error}</p>}
                        <button className="google-btn" onClick={handleGoogleLogin} disabled={loading}>
                            <span>üîê</span>
                            {loading ? 'Accesso in corso...' : 'Accedi con Google'}
                        </button>
                        <p className="login-hint">Al primo accesso potrai associare il tuo profilo</p>
                    </div>
                </div>
            );
        }

        function ClaimProfileModal({ users, onClaim, onNewPlayer }) {
            const [selectedPlayer, setSelectedPlayer] = useState('');
            const [newPlayerName, setNewPlayerName] = useState('');
            const availablePlayers = users.filter(u => !u.claimed && !u.id.startsWith('seed'));

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h2>üëã Benvenuto!</h2>
                        <p>Chi sei tra questi giocatori?</p>
                        <div className="form-group">
                            <label>Seleziona il tuo nome:</label>
                            <select value={selectedPlayer} onChange={(e) => setSelectedPlayer(e.target.value)}>
                                <option value="">-- Seleziona il tuo profilo --</option>
                                {availablePlayers.map(player => (
                                    <option key={player.id} value={player.id}>{player.name}</option>
                                ))}
                            </select>
                        </div>
                        <button className="btn btn-primary full-width" onClick={() => selectedPlayer && onClaim(selectedPlayer)} disabled={!selectedPlayer}>
                            ‚úì Sono io!
                        </button>
                        <div className="modal-divider">
                            <p className="modal-hint">Non trovi il tuo nome?</p>
                            <input type="text" placeholder="Scrivi il tuo nome e cognome" value={newPlayerName} onChange={(e) => setNewPlayerName(e.target.value)} />
                            <button className="btn btn-secondary full-width" onClick={() => onNewPlayer(newPlayerName)} disabled={!newPlayerName.trim()}>
                                + Sono un nuovo giocatore
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function RoleSelectionModal({ onSave }) {
            const [preferredRole, setPreferredRole] = useState('');
            const [otherRoles, setOtherRoles] = useState([]);

            const handleOtherRoleToggle = (role) => {
                if (otherRoles.includes(role)) {
                    setOtherRoles(otherRoles.filter(r => r !== role));
                } else {
                    setOtherRoles([...otherRoles, role]);
                }
            };

            const handleSubmit = () => {
                if (!preferredRole) { alert('Seleziona il tuo ruolo preferito'); return; }
                if (otherRoles.length < 2) { alert('Seleziona almeno 2 altri ruoli'); return; }
                onSave(preferredRole, otherRoles);
            };

            const availableOtherRoles = ROLES.filter(r => r !== preferredRole);

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h2>‚öΩ Benvenuto!</h2>
                        <p>Prima di iniziare, raccontaci qualcosa di te</p>
                        <div className="form-group">
                            <label>Qual √® il tuo ruolo preferito? *</label>
                            <select value={preferredRole} onChange={(e) => setPreferredRole(e.target.value)}>
                                <option value="">-- Seleziona --</option>
                                {ROLES.map(role => (<option key={role} value={role}>{role}</option>))}
                            </select>
                        </div>
                        <div className="form-group">
                            <label>In quali altri ruoli ti adatti? (min. 2) *</label>
                            <div className="checkbox-group">
                                {availableOtherRoles.map(role => (
                                    <div key={role} className="checkbox-item">
                                        <input type="checkbox" id={`role-${role}`} checked={otherRoles.includes(role)} onChange={() => handleOtherRoleToggle(role)} />
                                        <label htmlFor={`role-${role}`}>{role}</label>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <button className={`btn btn-primary full-width ${(!preferredRole || otherRoles.length < 2) ? 'btn-disabled' : ''}`} onClick={handleSubmit} disabled={!preferredRole || otherRoles.length < 2}>
                            Conferma {otherRoles.length < 2 && preferredRole ? `(${otherRoles.length}/2 ruoli)` : ''}
                        </button>
                    </div>
                </div>
            );
        }

        function Header({ user, onLogout }) {
            return (
                <div className="header">
                    <div className="header-left">
                        <h1>‚öΩ Calcetto del <span style={{color: 'var(--volt)'}}>gioved√¨</span></h1>
                        <p>Dedicata a quelli che il week-end inizia con la partitella</p>
                    </div>
                    <div className="user-info">
                        <div className="avatar">
                            {user.avatar ? <img src={user.avatar} alt={user.name} /> : utils.getInitials(user.name)}
                        </div>
                        <div>
                            <div className="user-name">{user.name}</div>
                            <div className="user-email">{user.email}</div>
                        </div>
                        <button className="logout-btn" onClick={onLogout}>Esci</button>
                    </div>
                </div>
            );
        }

        function PlayersListPage({ users, currentUser, votes, onSelectPlayer }) {
    const hasVoted = (playerId) => {
        return votes.some(v => v.voterId === currentUser.id && v.playerId === playerId);
    };
    
    const playersToVote = users.filter(u => {
        if (u.id === currentUser.id || u.id.startsWith('seed')) return false;
        if (hasVoted(u.id)) return false;
        if (currentUser.hasVotedOffline && u.isInitialPlayer) return false;
        return true;
    });

    return (
        <div className="section-container">
            <div className="section-header">
                <h2>Seleziona un giocatore da valutare</h2>
            </div>
            
            {playersToVote.length === 0 ? (
                <div className="no-votes">
                    <h3>üéâ Ottimo lavoro, hai valutato tutti!</h3>
                    {currentUser.hasVotedOffline && <p>Hai gi√† votato tutti. Potrai votare i nuovi iscritti.</p>}
                </div>
            ) : (
                <div className="players-grid">
                    {playersToVote.map(player => (
                        <div key={player.id} className="player-card" onClick={() => onSelectPlayer(player.id)}>
                            <div className="avatar">{player.avatar ? <img src={player.avatar} alt={player.name} /> : utils.getInitials(player.name)}</div>
                            <h3>{player.name}</h3>
                            <div className="status">
                                {!player.isInitialPlayer && <span className="new-badge">‚≠ê NUOVO</span>}
                                <div>Clicca per valutare</div>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

        function RatingForm({ player, onSubmit, onCancel }) {
            const [ratings, setRatings] = useState({});

            const isComplete = () => {
                const allSkills = [...SKILLS.tecniche, ...SKILLS.tattiche, ...SKILLS.fisiche];
                return allSkills.every(skill => ratings[skill]);
            };

            const handleSubmit = () => {
                if (isComplete()) { onSubmit(player.id, ratings); } 
                else { alert('Completa tutte le valutazioni prima di inviare'); }
            };

            return (
                <div className="rating-form">
                    <div className="form-header">
                        <div className="avatar">{player.avatar ? <img src={player.avatar} alt={player.name} /> : utils.getInitials(player.name)}</div>
                        <h2>Valuta {player.name}</h2>
                        <p>Scala: 1=Scarso | 2=Sufficiente | 3=Buono | 4=Ottimo</p>
                    </div>
                    {Object.entries(SKILLS).map(([category, skills]) => (
                        <div key={category} className="category-section">
                            <div className={`category-title category-${category}`}>{category.charAt(0).toUpperCase() + category.slice(1)}</div>
                            {skills.map(skill => (
                                <div key={skill} className="skill-item">
                                    <div className="skill-name">{skill}</div>
                                    <div className="rating-buttons">
                                        {[1, 2, 3, 4].map(value => (
                                            <button key={value} className={`rating-btn ${ratings[skill] === value ? 'selected' : ''}`} onClick={() => setRatings(prev => ({...prev, [skill]: value}))}>
                                                {value}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    ))}
                    <div className="form-actions">
                        <button className="btn btn-secondary" onClick={onCancel}>Annulla</button>
                        <button className="btn btn-primary" onClick={handleSubmit} disabled={!isComplete()}>‚úì Invia Valutazione</button>
                    </div>
                </div>
            );
        }

        function RadarChart({ data, labels, category }) {
            const canvasRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current || !data) return;
                const ctx = canvasRef.current.getContext('2d');
                if (canvasRef.current.chart) { canvasRef.current.chart.destroy(); }

                const colors = {
                    tecniche: 'rgba(102, 126, 234, 0.6)',
                    tattiche: 'rgba(72, 187, 120, 0.6)',
                    fisiche: 'rgba(245, 101, 101, 0.6)'
                };
                const borderColors = {
                    tecniche: 'rgb(102, 126, 234)',
                    tattiche: 'rgb(72, 187, 120)',
                    fisiche: 'rgb(245, 101, 101)'
                };

                canvasRef.current.chart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: category.charAt(0).toUpperCase() + category.slice(1),
                            data: labels.map(label => utils.toBase10(data[label])),
                            backgroundColor: colors[category],
                            borderColor: borderColors[category],
                            borderWidth: 2,
                            pointBackgroundColor: borderColors[category],
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: borderColors[category]
                        }]
                    },
                    options: {
                        scales: { 
                            r: { 
                                beginAtZero: true, 
                                max: 10, 
                                min: 0, 
                                ticks: { 
                                    stepSize: 2,
                                    color: 'rgba(255, 255, 255, 0.5)',
                                    backdropColor: 'transparent'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)',
                                    circular: true
                                },
                                angleLines: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                pointLabels: {
                                    color: 'rgba(255, 255, 255, 0.8)',
                                    font: {
                                        size: 11
                                    }
                                }
                            } 
                        },
                        plugins: { legend: { display: false } }
                    }
                });

                return () => { if (canvasRef.current?.chart) { canvasRef.current.chart.destroy(); } };
            }, [data, labels, category]);

            return <canvas ref={canvasRef} className="chart-canvas"></canvas>;
        }

function PlayerProfile({ player, votes, isOwnProfile }) {
    const playerVotes = votes.filter(v => v.playerId === player.id);
    const voteCount = playerVotes.length;
    const hasEnoughVotes = voteCount >= 5;
    const averages = utils.calculateAverages(player.id, votes);
    const overall = utils.calculateOverall(averages);
    const [flippedCard, setFlippedCard] = useState(null);

    const handleCardClick = (category) => {
        if (window.innerWidth <= 768) {
            setFlippedCard(flippedCard === category ? null : category);
        }
    };

    return (
        <div className="section-container">
            <div className="section-header">
                <h2>Profilo Giocatore</h2>
            </div>
            
            <div className="profile-header">
                <div className="avatar profile-avatar">
                    {player.avatar ? <img src={player.avatar} alt={player.name} /> : utils.getInitials(player.name)}
                </div>
                
                <div className="profile-header-info">
                    <h2>{player.name}</h2>
                    <div className="votes-count">Sulla basse di {voteCount} valutazioni ricevute</div>
                </div>
                
                {(player.preferredRole || (player.otherRoles && player.otherRoles.length > 0)) && (
                    <div className="role-info">
                        {player.preferredRole && (
                            <div className="role-item">
                                <div className="role-label">Ruolo preferito</div>
                                <div className="role-value">{player.preferredRole}</div>
                            </div>
                        )}
                        {player.otherRoles && player.otherRoles.length > 0 && (
                            <div className="role-item">
                                <div className="role-label">Mi adatto anche a</div>
                                <div className="role-badges">
                                    {player.otherRoles.map(role => (<span key={role} className="role-badge">{role}</span>))}
                                </div>
                            </div>
                        )}
                    </div>
                )}
            </div>

            {hasEnoughVotes && overall && (
                <div className="overall-container">
                    <div className="overall-main">{utils.toBase10(overall).toFixed(2)}</div>
                    <div className="overall-label">Overall Rating</div>
                </div>
            )}

            {hasEnoughVotes && averages ? (
                <div className="charts-container">
                    {Object.entries(SKILLS).map(([category, skills]) => {
                        const catOverall = utils.calculateCategoryOverall(averages, category);
                        return (
                            <div 
                                key={category} 
                                className={`chart-box ${flippedCard === category ? 'flipped' : ''}`}
                                onClick={() => handleCardClick(category)}
                            >
                                <div className="chart-box-inner">
                                    <div className="chart-box-front">
                                        <h3 className={`category-${category}`}>
                                            {category.charAt(0).toUpperCase() + category.slice(1)}
                                        </h3>
                                        {catOverall && (
                                            <div className="category-overall">
                                                {utils.toBase10(catOverall).toFixed(2)}
                                            </div>
                                        )}
                                        <RadarChart data={averages} labels={skills} category={category} />
                                    </div>
                                    
                                    <div className="chart-box-back">
                                        <h4 className={`category-${category}`}>
                                            {category.charAt(0).toUpperCase() + category.slice(1)}
                                        </h4>
                                        <div className="chart-detail-list">
                                            {skills.map(skill => (
                                                <div key={skill} className="chart-detail-item">
                                                    <span>{skill}</span>
                                                    <span className={`category-${category}`}>
                                                        {averages[skill] ? utils.toBase10(averages[skill]).toFixed(2) : '-'}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            ) : (
                <div className="no-votes">
                    <h3>üìä Grafici non disponibili</h3>
                    <p>{isOwnProfile ? "Chiedi ai tuoi compagni di valutarti!" : "Questo giocatore ha bisogno di pi√π valutazioni"}</p>
                    <p>Servono almeno 5 valutazioni (attualmente: {voteCount})</p>
                </div>
            )}
        </div>
    );
}
function ClassifichePage({ users, votes, onViewProfile }) {
    const playersWithStats = users
        .filter(u => !u.id.startsWith('seed'))
        .map(player => {
            const averages = utils.calculateAverages(player.id, votes);
            const overall = utils.calculateOverall(averages);
            const voteCount = utils.countVotes(player.id, votes);
            return { ...player, overall, voteCount };
        })
        .filter(p => p.overall !== null)
        .sort((a, b) => b.overall - a.overall);

    return (
        <div className="section-container">
            <div className="section-header">
                <h2>üìä Classifica Generale</h2>
            </div>
            
            {playersWithStats.length === 0 ? (
                <div className="no-votes">
                    <h3>Nessuna classifica disponibile</h3>
                    <p>I giocatori devono ricevere almeno 5 valutazioni per apparire</p>
                </div>
            ) : (
                <div className="leaderboard-container">
                    {playersWithStats.map((player, index) => (
                        <div 
                            key={player.id}
                            className={`leaderboard-item ${index < 3 ? `rank-${index + 1}` : ''}`}
                            onClick={() => onViewProfile(player.id)}
                        >
                            <div className="rank-number">
                                {index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`}
                            </div>
                            <div className="avatar">
                                {player.avatar ? <img src={player.avatar} alt={player.name} /> : utils.getInitials(player.name)}
                            </div>
                            <div style={{flex: 1}}>
                                <div style={{fontWeight: '600', fontSize: '18px'}}>{player.name}</div>
                                <div style={{fontSize: '13px', opacity: 0.8}}>{player.voteCount} valutazioni</div>
                            </div>
                            <div style={{fontWeight: '800', fontSize: '28px'}}>{utils.toBase10(player.overall).toFixed(2)}</div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

function SettingsPage({ user, onAvatarUpdate }) {
    const [showSuccess, setShowSuccess] = useState(false);
    const [showRoleEdit, setShowRoleEdit] = useState(false);

    const handleFileChange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onloadend = () => {
                onAvatarUpdate(reader.result);
                setShowSuccess(true);
                setTimeout(() => setShowSuccess(false), 3000);
            };
            reader.readAsDataURL(file);
        }
    };

    return (
        <div className="section-container">
            <div className="section-header">
                <h2>‚öôÔ∏è Impostazioni</h2>
            </div>
            
            <div className="settings-group">
                <h3>Foto Profilo</h3>
                <div style={{display: 'flex', alignItems: 'center', gap: '30px', flexWrap: 'wrap'}}>
                    <div className="avatar" style={{width: '100px', height: '100px', fontSize: '40px'}}>
                        {user.avatar ? <img src={user.avatar} alt={user.name} /> : utils.getInitials(user.name)}
                    </div>
                    <div className="file-input-wrapper">
                        <input type="file" id="avatar-upload" accept="image/*" onChange={handleFileChange} />
                        <label htmlFor="avatar-upload" className="file-input-label">üì∑ Carica Foto</label>
                    </div>
                </div>
            </div>

            <div className="settings-group">
                <h3>Informazioni Account</h3>
<div className="settings-info-box">
                    <div style={{marginBottom: '15px'}}><strong>Nome:</strong> {user.name}</div>
                    <div><strong>Email:</strong> {user.email}</div>
                </div>
            </div>

            <div className="settings-group">
                <h3>Ruoli</h3>
<div className="settings-info-box">
                    <div style={{marginBottom: '15px'}}>
                        <strong>Ruolo preferito:</strong> {user.preferredRole || 'Non impostato'}
                    </div>
                    <div style={{marginBottom: '15px'}}>
                        <strong>Altri ruoli:</strong>
                        <div style={{marginTop: '8px'}}>
                            {user.otherRoles && user.otherRoles.length > 0 ? (
                                <div className="role-badges">
                                    {user.otherRoles.map(role => (
                                        <span key={role} className="role-badge">{role}</span>
                                    ))}
                                </div>
                            ) : (
                                <span style={{color: '#718096'}}>Nessuno</span>
                            )}
                        </div>
                    </div>
                    <button className="btn btn-secondary" onClick={() => setShowRoleEdit(true)} style={{marginTop: '10px'}}>
                        ‚úèÔ∏è Modifica Ruoli
                    </button>
                </div>
            </div>

            {showSuccess && <div className="success-message">‚úì Impostazioni aggiornate!</div>}

            {showRoleEdit && (
                <RoleEditModal 
                    user={user}
                    onClose={() => setShowRoleEdit(false)}
                    onSuccess={() => { setShowRoleEdit(false); setShowSuccess(true); setTimeout(() => setShowSuccess(false), 3000); }}
                />
            )}
        </div>
    );
}


function AdminPage({ users, setUsers, votes, setVotes }) {
    const [editingPlayer, setEditingPlayer] = useState(null);
    const [editName, setEditName] = useState('');
    const [showSuccess, setShowSuccess] = useState(false);
    const [successMessage, setSuccessMessage] = useState('');
    const [editingVotes, setEditingVotes] = useState(null);
    const [voteValues, setVoteValues] = useState({});

    const showSuccessMsg = (msg) => {
        setSuccessMessage(msg);
        setShowSuccess(true);
        setTimeout(() => setShowSuccess(false), 3000);
    };

    const handleEditName = (player) => {
        setEditingPlayer(player.id);
        setEditName(player.name);
    };

    const handleSaveName = async (playerId) => {
        if (!editName.trim()) return;
        const updatedUser = users.find(u => u.id === playerId);
        updatedUser.name = editName.trim();
        await storage.updateUser(updatedUser);
        const updatedUsers = users.map(u => u.id === playerId ? updatedUser : u);
        setUsers(updatedUsers);
        setEditingPlayer(null);
        setEditName('');
        showSuccessMsg('Nome aggiornato!');
    };

    const handleDeletePlayer = async (playerId) => {
        if (!confirm('Eliminare questo giocatore e tutte le sue valutazioni?')) return;
        const updatedUsers = users.filter(u => u.id !== playerId);
        setUsers(updatedUsers);
        await storage.setUsers(updatedUsers);
        showSuccessMsg('Giocatore eliminato!');
    };

    const handleEditVotes = (player) => {
        const averages = utils.calculateAverages(player.id, votes);
        if (averages) {
            const values = {};
            Object.keys(averages).forEach(k => { values[k] = averages[k].toFixed(2); });
            setVoteValues(values);
        } else {
            const emptyValues = {};
            [...SKILLS.tecniche, ...SKILLS.tattiche, ...SKILLS.fisiche].forEach(skill => { emptyValues[skill] = ''; });
            setVoteValues(emptyValues);
        }
        setEditingVotes(player);
    };

    const handleSaveVotes = async () => {
        for (let i = 0; i < 8; i++) {
            const seedVote = { 
                voterId: `seed_admin_${i}_${Date.now()}`, 
                playerId: editingVotes.id, 
                ratings: {}, 
                timestamp: Date.now() 
            };
            [...SKILLS.tecniche, ...SKILLS.tattiche, ...SKILLS.fisiche].forEach(skill => {
                const value = parseFloat(voteValues[skill]);
                if (!isNaN(value)) seedVote.ratings[skill] = Math.round(value);
            });
            await storage.addVote(seedVote);
        }
        setEditingVotes(null);
        setVoteValues({});
        showSuccessMsg('Valutazioni aggiornate!');
        setTimeout(() => window.location.reload(), 1000);
    };

    const handleAddPlayer = async () => {
        const newName = prompt('Nome del nuovo giocatore:');
        if (!newName || !newName.trim()) return;
        const newPlayer = { id: `player${Date.now()}`, name: newName.trim(), avatar: null, preferredRole: null, otherRoles: [], email: null, claimed: false, isAdmin: false };
        await storage.updateUser(newPlayer);
        setUsers([...users, newPlayer]);
        showSuccessMsg('Giocatore aggiunto!');
    };

    const handleFullReset = () => {
        if (!confirm('‚ö†Ô∏è ATTENZIONE: Eliminare TUTTI i dati?')) return;
        if (!confirm('Conferma: vuoi davvero cancellare tutto?')) return;
        storage.clearAll();
        window.location.reload();
    };

    return (
        <div className="section-container">
            <div className="section-header">
                <h2>üîß Pannello Amministratore</h2>
            </div>

            {showSuccess && <div className="success-message">‚úì {successMessage}</div>}

            <div className="settings-group">
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                    <h3>üë• Gestione Giocatori ({users.filter(u => !u.id.startsWith('seed')).length})</h3>
                    <button className="btn btn-primary" onClick={handleAddPlayer}>+ Aggiungi</button>
                </div>
                
                <div className="admin-player-list">
                    {users.filter(u => !u.id.startsWith('seed')).map((player, index) => {
                        const voteCount = utils.countVotes(player.id, votes);
                        const averages = utils.calculateAverages(player.id, votes);
                        const overall = utils.calculateOverall(averages);
                        
                        return (
                            <div key={player.id} className="admin-player-item">
                                <span style={{color: '#a0aec0', width: '25px'}}>{index + 1}.</span>
                                
                                {editingPlayer === player.id ? (
                                    <div style={{display: 'flex', gap: '10px', flex: 1}}>
                                        <input type="text" value={editName} onChange={(e) => setEditName(e.target.value)} className="admin-input" autoFocus />
                                        <button onClick={() => handleSaveName(player.id)} className="admin-btn btn-save">‚úì</button>
                                        <button onClick={() => setEditingPlayer(null)} className="admin-btn btn-cancel">‚úï</button>
                                    </div>
                                ) : (
                                    <>
                                        <span style={{fontWeight: '600', minWidth: '140px'}}>{player.name}</span>
                                        <span style={{color: '#718096', fontSize: '13px', flex: 1}}>{player.claimed ? `‚úì ${player.email}` : '‚óã Non reclamato'}</span>
                                        <span style={{color: '#667eea', fontSize: '13px'}}>OVR: {overall ? utils.toBase10(overall).toFixed(2) : '-'} ({voteCount} voti)</span>
                                        <div style={{display: 'flex', gap: '6px'}}>
                                            <button onClick={() => handleEditName(player)} className="admin-btn">‚úèÔ∏è</button>
                                            <button onClick={() => handleEditVotes(player)} className="admin-btn btn-chart">üìä</button>
                                            <button onClick={() => handleDeletePlayer(player.id)} className="admin-btn btn-delete">üóëÔ∏è</button>
                                        </div>
                                    </>
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>
            
            <div className="settings-group">
                <h3>üíæ Backup Database</h3>
                <p>Esporta o importa tutti i dati (utenti e voti) per fare backup o ripristinare</p>
                <div style={{display: 'flex', gap: '15px', marginTop: '15px'}}>
                    <button className="btn btn-primary" onClick={() => {
                        const data = { users, votes, timestamp: Date.now(), date: new Date().toISOString() };
                        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `calcetto_backup_${new Date().toISOString().split('T')[0]}.json`;
                        a.click();
                        showSuccessMsg('Backup esportato!');
                    }}>üì• Esporta Backup</button>
                    <button className="btn btn-secondary" onClick={() => {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.json';
                        input.onchange = async (e) => {
                            try {
                                const file = e.target.files[0];
                                const text = await file.text();
                                const data = JSON.parse(text);
                                if (!confirm('‚ö†Ô∏è ATTENZIONE: Questo sovrascriver√† tutti i dati attuali. Continuare?')) return;
                                if (data.users) await storage.setUsers(data.users);
                                if (data.votes) await storage.setVotes(data.votes);
                                showSuccessMsg('Backup importato!');
                                setTimeout(() => window.location.reload(), 1000);
                            } catch (err) {
                                alert('Errore durante l\'importazione: ' + err.message);
                            }
                        };
                        input.click();
                    }}>üì§ Importa Backup</button>
                </div>
            </div>

            <div className="settings-group admin-danger-zone">
                <h3>‚ö†Ô∏è Zona Pericolosa</h3>
                <p>Azioni irreversibili!</p>
                <button className="btn btn-danger" onClick={handleFullReset}>üóëÔ∏è Reset Completo</button>
            </div>

            {editingVotes && (
                <div className="modal-overlay">
                    <div className="modal-content modal-large">
                        <h2>üìä Modifica: {editingVotes.name}</h2>
                        <p>Inserisci valori 1-4. Verranno creati 8 voti seed.</p>
                        {['tecniche', 'tattiche', 'fisiche'].map(category => (
                            <div key={category} className="vote-edit-category">
                                <h4 className={`category-${category}`}>{category}</h4>
                                <div className="vote-edit-grid">
                                    {SKILLS[category].map(skill => (
                                        <div key={skill} className="vote-edit-item">
                                            <label>{skill}</label>
                                            <input type="number" min="1" max="4" step="0.01" value={voteValues[skill] || ''} onChange={(e) => setVoteValues({...voteValues, [skill]: e.target.value})} />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                        <div className="modal-actions">
                            <button className="btn btn-secondary" onClick={() => setEditingVotes(null)}>Annulla</button>
                            <button className="btn btn-primary" onClick={handleSaveVotes}>Salva</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

function DebugPage({ users, votes }) {
    const [selectedPlayer, setSelectedPlayer] = useState(null);
    const [editingVote, setEditingVote] = useState(null);
    const [editVoteValues, setEditVoteValues] = useState({});

    const getVoteStats = (playerId) => {
        const playerVotes = votes.filter(v => v.playerId === playerId);
        const seedVotes = playerVotes.filter(v => v.voterId && v.voterId.startsWith('seed'));
        const realVotes = playerVotes.filter(v => v.voterId && !v.voterId.startsWith('seed'));
        return { total: playerVotes.length, seed: seedVotes.length, real: realVotes.length, allVotes: playerVotes };
    };

    const handleEditVote = (vote) => {
        setEditingVote(vote);
        setEditVoteValues(vote.ratings);
    };

    const handleSaveEditedVote = async () => {
        if (!editingVote.id) {
            alert('Impossibile modificare voti senza ID');
            return;
        }
        try {
            await db.collection('votes').doc(editingVote.id).update({ ratings: editVoteValues });
            alert('Voto aggiornato! Ricarica la pagina per vedere le modifiche.');
            setEditingVote(null);
        } catch (err) {
            alert('Errore durante il salvataggio: ' + err.message);
        }
    };

    const handleDeleteVote = async (voteId) => {
        if (!voteId) {
            alert('Impossibile eliminare voti senza ID');
            return;
        }
        if (!confirm('Eliminare questo voto?')) return;
        try {
            await db.collection('votes').doc(voteId).delete();
            alert('Voto eliminato! Ricarica la pagina.');
        } catch (err) {
            alert('Errore durante l\'eliminazione: ' + err.message);
        }
    };

    const players = users.filter(u => !u.id.startsWith('seed'));

    if (selectedPlayer) {
        const player = players.find(p => p.id === selectedPlayer);
        const stats = getVoteStats(player.id);
        const averages = utils.calculateAverages(player.id, votes);
        const overall = utils.calculateOverall(averages);

        return (
            <div className="section-container">
                <div className="section-header">
                    <h2>üìä Dettaglio: {player.name}</h2>
                    <button onClick={() => setSelectedPlayer(null)} className="btn-back">‚Üê Indietro</button>
                </div>

                <div className="debug-stats">
                    <div className="debug-stat-box"><div className="stat-value seed">{stats.seed}</div><div className="stat-label">Voti Seed</div></div>
                    <div className="debug-stat-box"><div className="stat-value real">{stats.real}</div><div className="stat-label">Voti Reali</div></div>
                    <div className="debug-stat-box"><div className="stat-value total">{stats.total}</div><div className="stat-label">Totale</div></div>
                    <div className="debug-stat-box"><div className="stat-value overall">{overall ? utils.toBase10(overall).toFixed(2) : '-'}</div><div className="stat-label">Overall</div></div>
                </div>

                <h3>üó≥Ô∏è Tutti i Voti</h3>
                <div className="debug-table-wrapper">
                    <table className="debug-table">
                        <thead>
                            <tr>
                                <th>Votante</th>
                                <th>Tipo</th>
                                {[...SKILLS.tecniche, ...SKILLS.tattiche, ...SKILLS.fisiche].map(skill => (<th key={skill}>{skill.substring(0, 6)}</th>))}
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            {stats.allVotes.map((vote, index) => {
                                const isSeed = vote.voterId.startsWith('seed');
                                const voterName = isSeed ? 'ü§ñ Seed' : (users.find(u => u.id === vote.voterId)?.name || 'Sconosciuto');
                                return (
                                    <tr key={index} className={index % 2 === 0 ? 'even' : 'odd'}>
                                        <td>{voterName}</td>
                                        <td><span className={`vote-type ${isSeed ? 'seed' : 'real'}`}>{isSeed ? 'Seed' : 'Reale'}</span></td>
                                        {[...SKILLS.tecniche, ...SKILLS.tattiche, ...SKILLS.fisiche].map(skill => (<td key={skill}>{vote.ratings[skill] || '-'}</td>))}
                                        <td>
                                            <button onClick={() => handleEditVote(vote)} className="admin-btn" style={{marginRight: '5px'}}>‚úèÔ∏è</button>
                                            <button onClick={() => handleDeleteVote(vote.id)} className="admin-btn btn-delete">üóëÔ∏è</button>
                                        </td>
                                    </tr>
                                );
                            })}
                            <tr className="average-row">
                                <td>üìä MEDIA</td>
                                <td></td>
                                {[...SKILLS.tecniche, ...SKILLS.tattiche, ...SKILLS.fisiche].map(skill => {
                                    const skillVotes = stats.allVotes.map(v => v.ratings[skill]).filter(v => v !== undefined);
                                    const avg = skillVotes.length > 0 ? skillVotes.reduce((a, b) => a + b, 0) / skillVotes.length : 0;
                                    return (<td key={skill}>{avg > 0 ? `${avg.toFixed(2)}` : '-'}</td>);
                                })}
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                {editingVote && (
                    <div className="modal-overlay">
                        <div className="modal-content modal-large">
                            <h2>‚úèÔ∏è Modifica Voto</h2>
                            <p>Votante: {editingVote.voterId.startsWith('seed') ? 'ü§ñ Seed' : (users.find(u => u.id === editingVote.voterId)?.name || 'Sconosciuto')}</p>
                            {['tecniche', 'tattiche', 'fisiche'].map(category => (
                                <div key={category} className="vote-edit-category">
                                    <h4 className={`category-${category}`}>{category}</h4>
                                    <div className="vote-edit-grid">
                                        {SKILLS[category].map(skill => (
                                            <div key={skill} className="vote-edit-item">
                                                <label>{skill}</label>
                                                <input 
                                                    type="number" 
                                                    min="1" 
                                                    max="4" 
                                                    step="0.01" 
                                                    value={editVoteValues[skill] || ''} 
                                                    onChange={(e) => setEditVoteValues({...editVoteValues, [skill]: parseFloat(e.target.value) || 0})} 
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                            <div className="modal-actions">
                                <button className="btn btn-secondary" onClick={() => setEditingVote(null)}>Annulla</button>
                                <button className="btn btn-primary" onClick={handleSaveEditedVote}>Salva</button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    return (
        <div className="section-container">
            <div className="section-header">
                <h2>üêõ Debug - Riepilogo Voti</h2>
            </div>

            <div className="debug-global-stats">
                <div className="debug-stat-box"><div className="stat-value seed">{votes.filter(v => v.voterId && v.voterId.startsWith('seed')).length}</div><div className="stat-label">Voti Seed Totali</div></div>
                <div className="debug-stat-box"><div className="stat-value real">{votes.filter(v => v.voterId && !v.voterId.startsWith('seed')).length}</div><div className="stat-label">Voti Reali Totali</div></div>
                <div className="debug-stat-box"><div className="stat-value total">{votes.length}</div><div className="stat-label">Voti Totali</div></div>
            </div>

            <div className="settings-group">
                <h3>üë• Dettaglio per Giocatore</h3>
                <div className="debug-player-list">
                    {players.map(player => {
                        const stats = getVoteStats(player.id);
                        const averages = utils.calculateAverages(player.id, votes);
                        const overall = utils.calculateOverall(averages);
                        return (
                            <div key={player.id} className="debug-player-item" onClick={() => setSelectedPlayer(player.id)}>
                                <span style={{fontWeight: '600', minWidth: '150px'}}>{player.name}</span>
                                <span className="debug-badge seed">Seed: {stats.seed}</span>
                                <span className="debug-badge real">Reali: {stats.real}</span>
                                <span className="debug-badge total">Tot: {stats.total}</span>
                                <span style={{color: '#667eea', fontSize: '14px'}}>OVR: {overall ? utils.toBase10(overall).toFixed(2) : '-'}</span>
                            </div>
                        );
                    })}
                </div>
            </div>
        </div>
    );
}
        function App() {
            const getPendingEmail = () => sessionStorage.getItem('pendingEmail');
            const setPendingEmailStorage = (email) => { if (email) { sessionStorage.setItem('pendingEmail', email); } else { sessionStorage.removeItem('pendingEmail'); } };

            const [currentUser, setCurrentUser] = useState(storage.getCurrentUser());
            const [activeTab, setActiveTab] = useState('valuta');
            const [selectedPlayer, setSelectedPlayer] = useState(null);
            const [viewingProfile, setViewingProfile] = useState(null);
            const [users, setUsers] = useState([]);
            const [votes, setVotes] = useState([]);
            const [showRoleModal, setShowRoleModal] = useState(false);
            const [showClaimModal, setShowClaimModal] = useState(false);
            const [pendingEmail, setPendingEmail] = useState(getPendingEmail());
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const loadData = async () => {
                    setLoading(true);
                    try {
                        let loadedUsers = await storage.getUsers();
                        if (loadedUsers.length === 0) { loadedUsers = []; }
                        const loadedVotes = await storage.getVotes();
                        setUsers(loadedUsers);
                        setVotes(loadedVotes);
                    } catch (error) {
                        console.error('Errore caricamento dati:', error);
                    }
                    setLoading(false);
                };
                loadData();
            }, []);

            useEffect(() => {
                if (loading || currentUser) return;
                const unsubscribe = firebase.auth().onAuthStateChanged((firebaseUser) => {
                    if (firebaseUser && firebaseUser.email) {
                        const email = firebaseUser.email;
                        const existingUser = users.find(u => u.email === email);
                        if (existingUser) {
                            const userWithAdmin = { ...existingUser, isAdmin: email === ADMIN_EMAIL };
                            setCurrentUser(userWithAdmin);
                            storage.setCurrentUser(userWithAdmin);
                            if (!existingUser.preferredRole) setShowRoleModal(true);
                        } else {
                            setPendingEmail(email);
                            setShowClaimModal(true);
                        }
                    }
                });
                return () => unsubscribe();
            }, [loading, users, currentUser]);

            const handleLogin = (email) => {
                const existingUser = users.find(u => u.email === email);
                if (existingUser) {
                    const userWithAdmin = { ...existingUser, isAdmin: email === ADMIN_EMAIL };
                    setCurrentUser(userWithAdmin);
                    storage.setCurrentUser(userWithAdmin);
                    if (!existingUser.preferredRole) setShowRoleModal(true);
                } else {
                    setPendingEmail(email);
                    setPendingEmailStorage(email);
                    setShowClaimModal(true);
                }
            };

            const handleClaimProfile = async (playerId) => {
                const isAdmin = pendingEmail === ADMIN_EMAIL;
                const claimedUser = { ...users.find(u => u.id === playerId), email: pendingEmail, claimed: true, isAdmin };
                await storage.updateUser(claimedUser);
                const updatedUsers = users.map(u => u.id === playerId ? claimedUser : u);
                setUsers(updatedUsers);
                setCurrentUser(claimedUser);
                storage.setCurrentUser(claimedUser);
                setShowClaimModal(false);
                setPendingEmail(null);
                setPendingEmailStorage(null);
                if (!claimedUser.preferredRole) setShowRoleModal(true);
            };

            const handleNewPlayer = async (playerName) => {
                const isAdmin = pendingEmail === ADMIN_EMAIL;
                const newUser = { id: `player${users.length + 1}`, name: playerName || pendingEmail.split('@')[0], email: pendingEmail, avatar: null, preferredRole: null, otherRoles: [], claimed: true, isAdmin: isAdmin, isInitialPlayer: false, hasVotedOffline: false };
                await storage.updateUser(newUser);
                setUsers([...users, newUser]);
                setCurrentUser(newUser);
                storage.setCurrentUser(newUser);
                setShowClaimModal(false);
                setPendingEmail(null);
                setPendingEmailStorage(null);
                setShowRoleModal(true);
            };

            const handleLogout = () => { firebase.auth().signOut(); setCurrentUser(null); storage.setCurrentUser(null); };

            const handleVoteSubmit = async (playerId, ratings) => {
                const newVote = { voterId: currentUser.id, voterName: currentUser.name, voterEmail: currentUser.email, playerId, ratings, timestamp: Date.now(), date: new Date().toISOString() };
                await storage.addVote(newVote);
                setVotes([...votes, newVote]);
                setSelectedPlayer(null);
            };

            const handleRolesSave = async (preferredRole, otherRoles) => {
                const updatedCurrentUser = { ...currentUser, preferredRole, otherRoles };
                await storage.updateUser(updatedCurrentUser);
                const updatedUsers = users.map(u => u.id === currentUser.id ? updatedCurrentUser : u);
                setUsers(updatedUsers);
                setCurrentUser(updatedCurrentUser);
                storage.setCurrentUser(updatedCurrentUser);
                setShowRoleModal(false);
            };

            if (loading) {
                return (<div className="login-container"><div className="login-card"><h1>‚öΩ Calcetto Rating</h1><p>Caricamento in corso...</p></div></div>);
            }

            if (!currentUser) {
                return (<>{showClaimModal && <ClaimProfileModal users={users} onClaim={handleClaimProfile} onNewPlayer={handleNewPlayer} />}<LoginPage onLogin={handleLogin} /></>);
            }

            return (
                <div className="app-container">
                    {showRoleModal && <RoleSelectionModal onSave={handleRolesSave} />}
                    <Header user={currentUser} onLogout={handleLogout} />
                    <div className="nav-tabs">
                        <button className={`nav-tab ${activeTab === 'valuta' ? 'active' : ''}`} onClick={() => { setActiveTab('valuta'); setSelectedPlayer(null); setViewingProfile(null); }}>‚öΩ Valuta</button>
                        <button className={`nav-tab ${activeTab === 'profilo' ? 'active' : ''}`} onClick={() => { setActiveTab('profilo'); setSelectedPlayer(null); setViewingProfile(null); }}>üë§ Profilo</button>
                        <button className={`nav-tab ${activeTab === 'classifiche' ? 'active' : ''}`} onClick={() => { setActiveTab('classifiche'); setSelectedPlayer(null); setViewingProfile(null); }}>üìä Classifiche</button>
                        <button className={`nav-tab ${activeTab === 'impostazioni' ? 'active' : ''}`} onClick={() => { setActiveTab('impostazioni'); setSelectedPlayer(null); setViewingProfile(null); }}>‚öôÔ∏è Impostazioni</button>
                        {currentUser.isAdmin && <button className={`nav-tab ${activeTab === 'admin' ? 'active' : ''}`} onClick={() => { setActiveTab('admin'); setSelectedPlayer(null); setViewingProfile(null); }}>üîß Admin</button>}
                        {currentUser.isAdmin && <button className={`nav-tab ${activeTab === 'debug' ? 'active' : ''}`} onClick={() => { setActiveTab('debug'); setSelectedPlayer(null); setViewingProfile(null); }}>üêõ Debug</button>}
                    </div>
                    <div className="content">
                        {viewingProfile ? (
                            <PlayerProfile player={users.find(u => u.id === viewingProfile)} votes={votes} isOwnProfile={viewingProfile === currentUser.id} />
                        ) : selectedPlayer ? (
                            <RatingForm player={users.find(u => u.id === selectedPlayer)} onSubmit={handleVoteSubmit} onCancel={() => setSelectedPlayer(null)} />
                        ) : activeTab === 'valuta' ? (
                            <PlayersListPage users={users} currentUser={currentUser} votes={votes} onSelectPlayer={setSelectedPlayer} />
                        ) : activeTab === 'profilo' ? (
                            <PlayerProfile player={currentUser} votes={votes} isOwnProfile={true} />
                        ) : activeTab === 'classifiche' ? (
                            <ClassifichePage users={users} votes={votes} onViewProfile={setViewingProfile} />
                        ) : activeTab === 'admin' && currentUser.isAdmin ? (
                            <AdminPage users={users} setUsers={setUsers} votes={votes} setVotes={setVotes} />
                        ) : activeTab === 'debug' && currentUser.isAdmin ? (
                            <DebugPage users={users} votes={votes} />
                        ) : (
                            <SettingsPage user={currentUser} onUpdateUser={async (updatedUser) => { await storage.updateUser(updatedUser); const updatedUsers = users.map(u => u.id === updatedUser.id ? updatedUser : u); setUsers(updatedUsers); setCurrentUser(updatedUser); storage.setCurrentUser(updatedUser); }} />
                        )}
                    </div>
                </div>
            );
        }

        try {
            ReactDOM.render(<App />, document.getElementById('root'));
        } catch (error) {
            document.getElementById('root').innerHTML = '<div style="color:white;text-align:center;padding:50px;"><h2>Errore caricamento</h2><p>' + error.message + '</p></div>';
        }
    </script>
</body>
</html>
