<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcetto Rating App</title>
    
    <!-- CSS SEPARATO - Modifica styles.css per cambiare l'aspetto -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Librerie esterne -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Firebase Compat (funziona senza modules) -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>	
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC_81ukybf3QOFFvJcgDWMgbor4Z7k1bgI",
    authDomain: "calcetto-af1e0.firebaseapp.com",
    projectId: "calcetto-af1e0",
    storageBucket: "calcetto-af1e0.firebasestorage.app",
    messagingSenderId: "1035881443344",
    appId: "1:1035881443344:web:2690813dc00bce70d19a95"
  };
  
firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>
</head>
<body>
<div id="root">
    <div style="display:flex;justify-content:center;align-items:center;min-height:100vh;">
        <div style="background:white;padding:40px;border-radius:20px;text-align:center;">
            <h2>‚öΩ Caricamento...</h2>
            <p>Se rimani bloccato qui, prova a ricaricare la pagina</p>
        </div>
    </div>
</div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

/* ============================================================================
   SEZIONE 1: CONFIGURAZIONE
   ============================================================================
   Modifica qui per: cambiare skill, cambiare ruoli
   ========================================================================== */

        // Email dell'amministratore
        const ADMIN_EMAIL = 'luigi.oliviero@gmail.com';

        // Le 15 skill divise per categoria
        const SKILLS = {
            tecniche: ['Tiro', 'Passaggio corto', 'Passaggio lungo', 'Contrasto', 'Controllo'],
            tattiche: ['Visione di gioco', 'Senso della posizione', 'Spirito di sacrificio', 'Letture difensive', 'Costruzione'],
            fisiche: ['Resistenza', 'Scatto', 'Progressione', 'Presenza fisica', 'Cazzimma']
        };

        // Ruoli disponibili
        const ROLES = [
            'Portiere',
            'Difensore centrale',
            'Difensore laterale sx',
            'Difensore laterale dx',
            'Centrocampista difensivo',
            'Centrocampista offensivo',
            'Mezzala sx',
            'Mezzala dx',
            'Centravanti'
        ];

/* ============================================================================
   SEZIONE 2: STORAGE (Firestore)
   ============================================================================
   Funzioni per salvare e recuperare dati dal cloud
   ========================================================================== */

        const storage = {
            // USERS
            getUsers: async () => {
                const snapshot = await db.collection('users').get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            },
            
            setUsers: async (users) => {
                const batch = db.batch();
                users.forEach(user => {
                    const ref = db.collection('users').doc(user.id);
                    batch.set(ref, user);
                });
                await batch.commit();
            },
            
            updateUser: async (user) => {
                await db.collection('users').doc(user.id).set(user);
            },
            
            // VOTES
            getVotes: async () => {
                const snapshot = await db.collection('votes').get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            },
            
            addVote: async (vote) => {
                await db.collection('votes').add(vote);
            },
            
            setVotes: async (votes) => {
                const batch = db.batch();
                votes.forEach((vote, index) => {
                    const ref = db.collection('votes').doc(`vote_${Date.now()}_${index}`);
                    batch.set(ref, vote);
                });
                await batch.commit();
            },
            
            // CURRENT USER (resta in localStorage - √® il login locale)
            getCurrentUser: () => JSON.parse(localStorage.getItem('calcetto_current_user') || 'null'),
            setCurrentUser: (user) => localStorage.setItem('calcetto_current_user', JSON.stringify(user)),
            
            // CLEAR
            clearAll: () => {
                localStorage.removeItem('calcetto_current_user');
            }
        };

/* ============================================================================
   SEZIONE 3: UTILITIES (Calcoli)
   ============================================================================
   Funzioni per calcolare medie e overall
   ========================================================================== */

        const utils = {
            calculateAverages: (playerId, votes) => {
                const playerVotes = votes.filter(v => v.playerId === playerId);
                if (playerVotes.length === 0) return null;
                
                const averages = {};
                const allSkills = [...SKILLS.tecniche, ...SKILLS.tattiche, ...SKILLS.fisiche];
                
                allSkills.forEach(skill => {
                    const values = playerVotes.map(v => v.ratings[skill]).filter(v => v !== undefined);
                    if (values.length > 0) {
                        averages[skill] = values.reduce((a, b) => a + b, 0) / values.length;
                    }
                });
                
                return averages;
            },
            
            calculateOverall: (averages) => {
                if (!averages) return null;
                const values = Object.values(averages);
                if (values.length === 0) return null;
                return values.reduce((a, b) => a + b, 0) / values.length;
            },
            
            calculateCategoryOverall: (averages, category) => {
                if (!averages) return null;
                const skills = SKILLS[category];
                const values = skills.map(s => averages[s]).filter(v => v !== undefined);
                if (values.length === 0) return null;
                return values.reduce((a, b) => a + b, 0) / values.length;
            },
            
            countVotes: (playerId, votes) => {
                return votes.filter(v => v.playerId === playerId).length;
            },
            toBase10: (value) => {
                return (value / 4) * 10;
            },
            getInitials: (name) => {
                return name.substring(0, 2).toUpperCase();
            }
        };

/* ============================================================================
   SEZIONE 4: COMPONENTE LOGIN PAGE
   ============================================================================
   Pagina di accesso con email
   ========================================================================== */

        function LoginPage({ onLogin }) {
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

const handleGoogleLogin = () => {
                setLoading(true);
                setError('');
                
                const provider = new firebase.auth.GoogleAuthProvider();
                
                // Usa sempre popup, sia mobile che desktop
                firebase.auth().signInWithPopup(provider)
                    .then((result) => {
                        onLogin(result.user.email);
                    })
                    .catch((err) => {
                        console.error(err);
                        setError('Errore: ' + err.message);
                        setLoading(false);
                    });
            };

	
            return (
                <div className="login-container">
                    <div className="login-card">
                        <h1>‚öΩ Calcetto Rating</h1>
                        <p>Valuta i tuoi compagni di squadra</p>
                        
                        {error && <p style={{color: '#e53e3e', marginBottom: '20px', fontSize: '14px'}}>{error}</p>}
                        
                        <button 
                            className="google-btn" 
                            onClick={handleGoogleLogin}
                            disabled={loading}
                        >
                            <span style={{fontSize: '24px'}}>üîê</span>
                            {loading ? 'Accesso in corso...' : 'Accedi con Google'}
                        </button>
                        
                        <p style={{marginTop: '30px', fontSize: '12px', color: '#a0aec0'}}>
                            Al primo accesso potrai associare il tuo profilo
                        </p>
                    </div>
                </div>
            );
        }

/* ============================================================================
   SEZIONE 5: COMPONENTE CLAIM MODAL
   ============================================================================
   Modal per associare email a profilo esistente
   ========================================================================== */

        function ClaimProfileModal({ users, onClaim, onNewPlayer }) {
            const [selectedPlayer, setSelectedPlayer] = useState('');
            const [newPlayerName, setNewPlayerName] = useState('');
            const availablePlayers = users.filter(u => 
                !u.claimed && !u.id.startsWith('seed')
            );

            const handleClaim = () => {
                if (selectedPlayer) {
                    onClaim(selectedPlayer);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h2>üëã Benvenuto!</h2>
                        <p>Chi sei tra questi giocatori?</p>

                        <div className="form-group">
                            <label>Seleziona il tuo nome:</label>
                            <select 
                                value={selectedPlayer} 
                                onChange={(e) => setSelectedPlayer(e.target.value)}
                                style={{marginBottom: '15px'}}
                            >
                                <option value="">-- Seleziona il tuo profilo --</option>
                                {availablePlayers.map(player => (
                                    <option key={player.id} value={player.id}>
                                        {player.name}
                                    </option>
                                ))}
                            </select>
                        </div>

                        <button 
                            className="btn btn-primary" 
                            onClick={handleClaim}
                            disabled={!selectedPlayer}
                            style={{width: '100%', marginBottom: '15px', opacity: selectedPlayer ? 1 : 0.5}}
                        >
                            ‚úì Sono io!
                        </button>

						<div style={{
                            borderTop: '1px solid #e2e8f0',
                            paddingTop: '20px',
                            marginTop: '10px',
                            textAlign: 'center'
                        }}>
                            <p style={{color: '#718096', fontSize: '14px', marginBottom: '15px'}}>
                                Non trovi il tuo nome?
                            </p>
                            <input 
                                type="text"
                                placeholder="Scrivi il tuo nome e cognome"
                                value={newPlayerName}
                                onChange={(e) => setNewPlayerName(e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    borderRadius: '10px',
                                    border: '2px solid #e2e8f0',
                                    marginBottom: '15px',
                                    fontSize: '16px'
                                }}
                            />
                            <button 
                                className="btn btn-secondary"
                                onClick={() => onNewPlayer(newPlayerName)}
                                style={{width: '100%', opacity: newPlayerName.trim() ? 1 : 0.5}}
                                disabled={!newPlayerName.trim()}
                            >
                                + Sono un nuovo giocatore
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

/* ============================================================================
   SEZIONE 6: COMPONENTE ROLE SELECTION MODAL
   ============================================================================
   Modal per selezionare ruolo preferito e altri ruoli
   ========================================================================== */

        function RoleSelectionModal({ onSave }) {
            const [preferredRole, setPreferredRole] = useState('');
            const [otherRoles, setOtherRoles] = useState([]);

            const handleOtherRoleToggle = (role) => {
                if (otherRoles.includes(role)) {
                    setOtherRoles(otherRoles.filter(r => r !== role));
                } else {
                    setOtherRoles([...otherRoles, role]);
                }
            };

            const handleSubmit = () => {
                if (!preferredRole) {
                    alert('Seleziona il tuo ruolo preferito');
                    return;
                }
                if (otherRoles.length < 2) {
                    alert('Seleziona almeno 2 altri ruoli');
                    return;
                }
                onSave(preferredRole, otherRoles);
            };

            const availableOtherRoles = ROLES.filter(r => r !== preferredRole);

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h2>‚öΩ Benvenuto!</h2>
                        <p>Prima di iniziare, raccontaci qualcosa di te</p>

                        <div className="form-group">
                            <label>Qual √® il tuo ruolo preferito? *</label>
                            <select 
                                value={preferredRole} 
                                onChange={(e) => setPreferredRole(e.target.value)}
                            >
                                <option value="">-- Seleziona --</option>
                                {ROLES.map(role => (
                                    <option key={role} value={role}>{role}</option>
                                ))}
                            </select>
                        </div>

                        <div className="form-group">
                            <label>In quali altri ruoli ti adatti? (min. 2) *</label>
                            <div className="checkbox-group">
                                {availableOtherRoles.map(role => (
                                    <div key={role} className="checkbox-item">
                                        <input 
                                            type="checkbox"
                                            id={`role-${role}`}
                                            checked={otherRoles.includes(role)}
                                            onChange={() => handleOtherRoleToggle(role)}
                                        />
                                        <label htmlFor={`role-${role}`}>{role}</label>
                                    </div>
                                ))}
                            </div>
                        </div>

<button 
                            className={`btn btn-primary ${(!preferredRole || otherRoles.length < 2) ? 'btn-disabled' : ''}`}
                            onClick={handleSubmit}
                            disabled={!preferredRole || otherRoles.length < 2}
                            style={{width: '100%', marginTop: '20px'}}
                        >
                            Conferma {otherRoles.length < 2 && preferredRole ? `(${otherRoles.length}/2 ruoli)` : ''}
                        </button>
                    </div>
                </div>
            );
        }

/* ============================================================================
   SEZIONE 7: COMPONENTE HEADER
   ============================================================================
   Barra superiore con logo, info utente e logout
   ========================================================================== */

        function Header({ user, onLogout }) {
            return (
                <div className="header">
                    <div className="header-left">
                        <h1>‚öΩ Calcetto Rating</h1>
                        <p>Sistema di valutazione giocatori</p>
                    </div>
                    <div className="user-info">
                        <div className="avatar">
                            {user.avatar ? (
                                <img src={user.avatar} alt={user.name} />
                            ) : (
                                utils.getInitials(user.name)
                            )}
                        </div>
                        <div>
                            <div style={{fontWeight: '600', color: '#2d3748'}}>{user.name}</div>
                            <div style={{fontSize: '13px', color: '#718096'}}>{user.email}</div>
                        </div>
                        <button className="logout-btn" onClick={onLogout}>
                            Esci
                        </button>
                    </div>
                </div>
            );
        }

/* ============================================================================
   SEZIONE 8: COMPONENTE PLAYERS LIST PAGE
   ============================================================================
   Griglia di giocatori da votare
   ========================================================================== */

        function PlayersListPage({ users, currentUser, votes, onSelectPlayer }) {
            const hasVoted = (playerId) => {
                return votes.some(v => v.voterId === currentUser.id && v.playerId === playerId);
            };

            // Mostra solo giocatori non ancora votati
            const playersToVote = users.filter(u => {
                // Escludi se stesso e seed
                if (u.id === currentUser.id || u.id.startsWith('seed')) return false;
                
                // Escludi gi√† votati nell'app
                if (hasVoted(u.id)) return false;
                
                // Se l'utente corrente ha votato offline, escludi i giocatori iniziali
                if (currentUser.hasVotedOffline && u.isInitialPlayer) return false;
                
                return true;
            });

            return (
                <div>
                    <h2 style={{marginBottom: '30px', color: '#2d3748'}}>
                        Seleziona un giocatore da valutare
                    </h2>
                    
                    {playersToVote.length === 0 ? (
                        <div className="no-votes">
                            <h3>üéâ Ottimo lavoro, hai valutato tutti!</h3>
                            {currentUser.hasVotedOffline && (
                                <p style={{marginTop: '15px', color: '#718096'}}>
                                    Hai gi√† votato tutti. Potrai votare i nuovi iscritti.
                                </p>
                            )}
                        </div>
                    ) : (
                    <div className="players-grid">
                        {playersToVote.map(player => (
                            <div 
                                key={player.id}
                                className="player-card"
                                onClick={() => onSelectPlayer(player.id)}
                                style={{cursor: 'pointer'}}
                            >
                                <div className="avatar">
                                    {player.avatar ? (
                                        <img src={player.avatar} alt={player.name} />
                                    ) : (
                                        utils.getInitials(player.name)
                                    )}
                                </div>
                                <h3>{player.name}</h3>
                                <div className="status">
                                    {!player.isInitialPlayer && (
                                        <span style={{
                                            background: '#48bb78',
                                            color: 'white',
                                            padding: '4px 10px',
                                            borderRadius: '12px',
                                            fontSize: '11px',
                                            fontWeight: '600',
                                            display: 'inline-block',
                                            marginBottom: '8px'
                                        }}>
                                            ‚≠ê NUOVO
                                        </span>
                                    )}
                                    <div>Clicca per valutare</div>
                                </div>
                            </div>
                        ))}
                    </div>
                    )}
                </div>
            );
        }
/* ============================================================================
   SEZIONE 9: COMPONENTE RATING FORM
   ============================================================================
   Form per votare un giocatore su tutte le 15 skill
   ========================================================================== */

        function RatingForm({ player, onSubmit, onCancel }) {
            const [ratings, setRatings] = useState({});

            const handleRating = (skill, value) => {
                setRatings(prev => ({
                    ...prev,
                    [skill]: value
                }));
            };

            const isComplete = () => {
                const allSkills = [...SKILLS.tecniche, ...SKILLS.tattiche, ...SKILLS.fisiche];
                return allSkills.every(skill => ratings[skill]);
            };

            const handleSubmit = () => {
                if (isComplete()) {
                    onSubmit(player.id, ratings);
                } else {
                    alert('Completa tutte le valutazioni prima di inviare');
                }
            };

            return (
                <div className="rating-form">
                    <div className="form-header">
                        <div className="avatar">
                            {player.avatar ? (
                                <img src={player.avatar} alt={player.name} />
                            ) : (
                                utils.getInitials(player.name)
                            )}
                        </div>
                        <h2>Valuta {player.name}</h2>
                        <p style={{color: '#718096'}}>Scala: 1=Scarso | 2=Sufficiente | 3=Buono | 4=Ottimo</p>
                    </div>

                    {Object.entries(SKILLS).map(([category, skills]) => (
                        <div key={category} className="category-section">
                            <div className="category-title" style={{
                                color: category === 'tecniche' ? '#667eea' : 
                                       category === 'tattiche' ? '#48bb78' : '#f56565'
                            }}>
                                {category.charAt(0).toUpperCase() + category.slice(1)}
                            </div>
                            {skills.map(skill => (
                                <div key={skill} className="skill-item">
                                    <div className="skill-name">{skill}</div>
                                    <div className="rating-buttons">
                                        {[1, 2, 3, 4].map(value => (
                                            <button
                                                key={value}
                                                className={`rating-btn ${ratings[skill] === value ? 'selected' : ''}`}
                                                onClick={() => handleRating(skill, value)}
                                            >
                                                {value}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    ))}

                    <div className="form-actions">
                        <button className="btn btn-secondary" onClick={onCancel}>
                            Annulla
                        </button>
                        <button 
                            className="btn btn-primary" 
                            onClick={handleSubmit}
                            style={{opacity: isComplete() ? 1 : 0.5}}
                        >
                            ‚úì Invia Valutazione
                        </button>
                    </div>
                </div>
            );
        }

/* ============================================================================
   SEZIONE 10: COMPONENTE RADAR CHART
   ============================================================================
   Grafico radar (pentagono) per visualizzare le skill
   ========================================================================== */

        function RadarChart({ data, labels, category }) {
            const canvasRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current || !data) return;

                const ctx = canvasRef.current.getContext('2d');
                
                if (canvasRef.current.chart) {
                    canvasRef.current.chart.destroy();
                }

                const colors = {
                    tecniche: 'rgba(102, 126, 234, 0.6)',
                    tattiche: 'rgba(72, 187, 120, 0.6)',
                    fisiche: 'rgba(245, 101, 101, 0.6)'
                };

                const borderColors = {
                    tecniche: 'rgb(102, 126, 234)',
                    tattiche: 'rgb(72, 187, 120)',
                    fisiche: 'rgb(245, 101, 101)'
                };

                canvasRef.current.chart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: category.charAt(0).toUpperCase() + category.slice(1),
							data: labels.map(label => utils.toBase10(data[label])),
							backgroundColor: colors[category],
                            borderColor: borderColors[category],
                            borderWidth: 2,
                            pointBackgroundColor: borderColors[category],
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: borderColors[category]
                        }]
                    },
                    options: {
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 10,
                                min: 0,
                                ticks: { stepSize: 2 }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });

                return () => {
                    if (canvasRef.current?.chart) {
                        canvasRef.current.chart.destroy();
                    }
                };
            }, [data, labels, category]);

            return <canvas ref={canvasRef} className="chart-canvas"></canvas>;
        }

/* ============================================================================
   SEZIONE 11: COMPONENTE PLAYER PROFILE
   ============================================================================
   Visualizzazione profilo giocatore con grafici radar (solo lettura)
   ========================================================================== */

        function PlayerProfile({ player, votes, isOwnProfile }) {
            const playerVotes = votes.filter(v => v.playerId === player.id);
            const voteCount = playerVotes.length;
            const hasEnoughVotes = voteCount >= 5;

            const averages = utils.calculateAverages(player.id, votes);
            const overall = utils.calculateOverall(averages);

            return (
                <div className="profile-container">
                    <div className="profile-header">
                        <div className="avatar" style={{width: '120px', height: '120px', fontSize: '48px'}}>
                            {player.avatar ? (
                                <img src={player.avatar} alt={player.name} />
                            ) : (
                                utils.getInitials(player.name)
                            )}
                        </div>
                        <h2>{player.name}</h2>
                        <div className="votes-count">
                            {voteCount} {voteCount === 1 ? 'valutazione' : 'valutazioni'} ricevute
                        </div>
                    </div>

                    {hasEnoughVotes && overall && (
                        <div className="overall-container">
                            <div className="overall-main">{utils.toBase10(overall).toFixed(2)}</div>
                            <div className="overall-label">Overall</div>
                        </div>
                    )}

                    {/* SEZIONE RUOLI */}
                    {(player.preferredRole || (player.otherRoles && player.otherRoles.length > 0)) && (
                        <div style={{
                            background: '#f7fafc',
                            borderRadius: '16px',
                            padding: '25px',
                            marginBottom: '30px'
                        }}>
                            <h3 style={{
                                color: '#2d3748',
                                marginBottom: '20px',
                                fontSize: '18px'
                            }}>
                                ‚öΩ Ruoli
                            </h3>
                            <div style={{display: 'flex', flexWrap: 'wrap', gap: '20px'}}>
                                {player.preferredRole && (
                                    <div style={{flex: '1', minWidth: '200px'}}>
                                        <div style={{fontSize: '13px', color: '#718096', marginBottom: '5px'}}>
                                            Ruolo preferito
                                        </div>
                                        <div style={{
                                            fontSize: '16px',
                                            fontWeight: '600',
                                            background: 'linear-gradient(135deg, #667eea, #764ba2)',
                                            color: 'white',
                                            padding: '8px 16px',
                                            borderRadius: '20px',
                                            display: 'inline-block'
                                        }}>
                                            {player.preferredRole}
                                        </div>
                                    </div>
                                )}
                                {player.otherRoles && player.otherRoles.length > 0 && (
                                    <div style={{flex: '2', minWidth: '300px'}}>
                                        <div style={{fontSize: '13px', color: '#718096', marginBottom: '5px'}}>
                                            Mi adatto anche a
                                        </div>
                                        <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px'}}>
                                            {player.otherRoles.map(role => (
                                                <span key={role} style={{
                                                    background: '#e2e8f0',
                                                    color: '#4a5568',
                                                    padding: '6px 14px',
                                                    borderRadius: '15px',
                                                    fontSize: '14px',
                                                    fontWeight: '500'
                                                }}>
                                                    {role}
                                                </span>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* GRAFICI E STATISTICHE */}
                    {hasEnoughVotes && averages ? (
                        <>
                        <div className="charts-container">
                            {Object.entries(SKILLS).map(([category, skills]) => {
                                const catOverall = utils.calculateCategoryOverall(averages, category);
                                return (
                                    <div key={category} className="chart-box">
                                        <h3 style={{
                                            color: category === 'tecniche' ? '#667eea' : 
                                                   category === 'tattiche' ? '#48bb78' : '#f56565'
                                        }}>
                                            {category.charAt(0).toUpperCase() + category.slice(1)}
                                        </h3>
                                        {catOverall && (
                                            <div className="category-overall">
                                                {utils.toBase10(catOverall).toFixed(2)}
                                            </div>
                                        )}
                                        <RadarChart 
                                            data={averages}
                                            labels={skills}
                                            category={category}
                                        />
                                    </div>
                                );
                            })}
                        </div>

                        {/* Tabella riepilogativa */}
                        <div style={{marginTop: '40px'}}>
                            <h3 style={{color: '#2d3748', marginBottom: '20px', textAlign: 'center'}}>
                                üìã Dettaglio Valutazioni
                            </h3>
                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '20px'}}>
                                {Object.entries(SKILLS).map(([category, skills]) => (
                                    <div key={category} style={{background: '#f7fafc', borderRadius: '12px', padding: '20px'}}>
                                        <h4 style={{
                                            color: category === 'tecniche' ? '#667eea' : category === 'tattiche' ? '#48bb78' : '#f56565',
                                            marginBottom: '15px',
                                            textTransform: 'capitalize',
                                            borderBottom: '2px solid',
                                            borderColor: category === 'tecniche' ? '#667eea' : category === 'tattiche' ? '#48bb78' : '#f56565',
                                            paddingBottom: '10px'
                                        }}>
                                            {category}
                                        </h4>
                                        {skills.map(skill => (
                                            <div key={skill} style={{
                                                display: 'flex',
                                                justifyContent: 'space-between',
                                                alignItems: 'center',
                                                padding: '8px 0',
                                                borderBottom: '1px solid #e2e8f0'
                                            }}>
                                                <span style={{fontSize: '14px', color: '#4a5568'}}>{skill}</span>
                                                <span style={{
                                                    fontWeight: '700',
                                                    fontSize: '16px',
                                                    color: category === 'tecniche' ? '#667eea' : category === 'tattiche' ? '#48bb78' : '#f56565'
                                                }}>
                                                    {averages[skill] ? utils.toBase10(averages[skill]).toFixed(2) : '-'}
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        </div>
                        </>
                    ) : (
                        <div className="no-votes">
                            <h3>üìä Grafici non disponibili</h3>
                            <p>
                                {isOwnProfile 
                                    ? "Chiedi ai tuoi compagni di valutarti!" 
                                    : "Questo giocatore ha bisogno di pi√π valutazioni"}
                            </p>
                            <p style={{marginTop: '10px', fontSize: '14px'}}>
                                Servono almeno 5 valutazioni (attualmente: {voteCount})
                            </p>
                        </div>
                    )}
                </div>
            );
        }

/* ============================================================================
   SEZIONE 12: COMPONENTE CLASSIFICHE PAGE
   ============================================================================
   Classifica giocatori per overall
   ========================================================================== */

        function ClassifichePage({ users, votes, onViewProfile }) {
            const playersWithStats = users
                .filter(u => !u.id.startsWith('seed'))
                .map(player => {
                    const averages = utils.calculateAverages(player.id, votes);
                    const overall = utils.calculateOverall(averages);
                    const voteCount = utils.countVotes(player.id, votes);
                    return { ...player, overall, voteCount };
                })
                .filter(p => p.overall !== null)
                .sort((a, b) => b.overall - a.overall);

            return (
                <div>
                    <h2 style={{marginBottom: '30px', color: '#2d3748'}}>
                        üìä Classifica Generale
                    </h2>
                    
                    {playersWithStats.length === 0 ? (
                        <div className="no-votes">
                            <h3>Nessuna classifica disponibile</h3>
                            <p>I giocatori devono ricevere almeno 5 valutazioni per apparire</p>
                        </div>
                    ) : (
                        <div style={{maxWidth: '800px', margin: '0 auto'}}>
                            {playersWithStats.map((player, index) => (
                                <div 
                                    key={player.id}
                                    onClick={() => onViewProfile(player.id)}
                                    style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        padding: '20px',
                                        background: index === 0 ? 'linear-gradient(135deg, #ffd700, #ffb800)' :
                                                   index === 1 ? 'linear-gradient(135deg, #c0c0c0, #a8a8a8)' :
                                                   index === 2 ? 'linear-gradient(135deg, #cd7f32, #b87333)' : '#f7fafc',
                                        color: index < 3 ? 'white' : '#2d3748',
                                        borderRadius: '12px',
                                        marginBottom: '10px',
                                        cursor: 'pointer',
                                        transition: 'all 0.3s'
                                    }}
                                >
                                    <div style={{width: '40px', fontWeight: '700', fontSize: '20px'}}>
                                        {index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`}
                                    </div>
                                    <div className="avatar" style={{width: '50px', height: '50px', fontSize: '18px', marginRight: '15px'}}>
                                        {player.avatar ? (
                                            <img src={player.avatar} alt={player.name} />
                                        ) : (
                                            utils.getInitials(player.name)
                                        )}
                                    </div>
                                    <div style={{flex: 1}}>
                                        <div style={{fontWeight: '600', fontSize: '18px'}}>{player.name}</div>
                                        <div style={{fontSize: '13px', opacity: 0.8}}>{player.voteCount} valutazioni</div>
                                    </div>
                                    <div style={{fontWeight: '800', fontSize: '28px'}}>{utils.toBase10(player.overall).toFixed(2)}</div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

/* ============================================================================
   SEZIONE 13: COMPONENTE SETTINGS PAGE
   ============================================================================
   Impostazioni utente: nome, foto, ruoli - con editing inline
   ========================================================================== */

        function SettingsPage({ user, onUpdateUser }) {
            const [isEditing, setIsEditing] = useState(false);
            const [editName, setEditName] = useState(user.name);
            const [editAvatar, setEditAvatar] = useState(user.avatar);
            const [editPreferredRole, setEditPreferredRole] = useState(user.preferredRole || '');
            const [editOtherRoles, setEditOtherRoles] = useState(user.otherRoles || []);
            const [saving, setSaving] = useState(false);
            const [showSuccess, setShowSuccess] = useState(false);

            const handleAvatarChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setEditAvatar(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleOtherRoleToggle = (role) => {
                if (editOtherRoles.includes(role)) {
                    setEditOtherRoles(editOtherRoles.filter(r => r !== role));
                } else {
                    setEditOtherRoles([...editOtherRoles, role]);
                }
            };

            const handleSave = async () => {
                if (!editName.trim()) {
                    alert('Il nome non pu√≤ essere vuoto');
                    return;
                }
                if (!editPreferredRole) {
                    alert('Seleziona il tuo ruolo preferito');
                    return;
                }
                if (editOtherRoles.length < 2) {
                    alert('Seleziona almeno 2 altri ruoli');
                    return;
                }

                setSaving(true);
                await onUpdateUser({
                    ...user,
                    name: editName.trim(),
                    avatar: editAvatar,
                    preferredRole: editPreferredRole,
                    otherRoles: editOtherRoles
                });
                setSaving(false);
                setIsEditing(false);
                setShowSuccess(true);
                setTimeout(() => setShowSuccess(false), 3000);
            };

            const handleCancel = () => {
                setEditName(user.name);
                setEditAvatar(user.avatar);
                setEditPreferredRole(user.preferredRole || '');
                setEditOtherRoles(user.otherRoles || []);
                setIsEditing(false);
            };

            const availableOtherRoles = ROLES.filter(r => r !== editPreferredRole);

            return (
                <div style={{maxWidth: '600px', margin: '0 auto'}}>
                    <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        marginBottom: '30px'
                    }}>
                        <h2 style={{color: '#2d3748', margin: 0}}>‚öôÔ∏è Impostazioni</h2>
                        {!isEditing && (
                            <button 
                                onClick={() => setIsEditing(true)}
                                style={{
                                    background: 'linear-gradient(135deg, #667eea, #764ba2)',
                                    color: 'white',
                                    border: 'none',
                                    padding: '10px 20px',
                                    borderRadius: '10px',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px'
                                }}
                            >
                                ‚úèÔ∏è Modifica
                            </button>
                        )}
                    </div>

                    {showSuccess && (
                        <div style={{
                            background: 'linear-gradient(135deg, #48bb78, #38a169)',
                            color: 'white',
                            padding: '15px 20px',
                            borderRadius: '10px',
                            marginBottom: '20px',
                            textAlign: 'center',
                            fontWeight: '600'
                        }}>
                            ‚úì Modifiche salvate con successo!
                        </div>
                    )}

                    {/* CARD PROFILO */}
                    <div style={{
                        background: '#f7fafc',
                        borderRadius: '16px',
                        padding: '30px',
                        marginBottom: '20px'
                    }}>
                        <h3 style={{
                            color: '#2d3748',
                            marginBottom: '25px',
                            fontSize: '18px'
                        }}>
                            üë§ Profilo
                        </h3>

                        {/* AVATAR */}
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '25px',
                            marginBottom: '25px',
                            paddingBottom: '25px',
                            borderBottom: '1px solid #e2e8f0'
                        }}>
                            <div style={{position: 'relative', display: 'inline-block'}}>
                                <div className="avatar" style={{width: '100px', height: '100px', fontSize: '40px'}}>
                                    {(isEditing ? editAvatar : user.avatar) ? (
                                        <img src={isEditing ? editAvatar : user.avatar} alt={user.name} />
                                    ) : (
                                        utils.getInitials(isEditing ? editName : user.name)
                                    )}
                                </div>
                                {isEditing && (
                                    <label style={{
                                        position: 'absolute',
                                        bottom: '0',
                                        right: '0',
                                        background: '#667eea',
                                        color: 'white',
                                        width: '32px',
                                        height: '32px',
                                        borderRadius: '50%',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        cursor: 'pointer',
                                        fontSize: '16px',
                                        border: '3px solid white'
                                    }}>
                                        üì∑
                                        <input 
                                            type="file" 
                                            accept="image/*" 
                                            onChange={handleAvatarChange}
                                            style={{display: 'none'}}
                                        />
                                    </label>
                                )}
                            </div>
                            <div style={{flex: 1}}>
                                <div style={{fontSize: '13px', color: '#718096', marginBottom: '5px'}}>
                                    Foto profilo
                                </div>
                                {isEditing ? (
                                    <div style={{fontSize: '14px', color: '#4a5568'}}>
                                        Clicca sull'icona üì∑ per cambiare foto
                                    </div>
                                ) : (
                                    <div style={{fontSize: '14px', color: '#4a5568'}}>
                                        {user.avatar ? 'Foto caricata' : 'Nessuna foto'}
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* NOME */}
                        <div style={{
                            marginBottom: '25px',
                            paddingBottom: '25px',
                            borderBottom: '1px solid #e2e8f0'
                        }}>
                            <div style={{fontSize: '13px', color: '#718096', marginBottom: '8px'}}>
                                Nome
                            </div>
                            {isEditing ? (
                                <input 
                                    type="text"
                                    value={editName}
                                    onChange={(e) => setEditName(e.target.value)}
                                    style={{
                                        width: '100%',
                                        padding: '12px',
                                        fontSize: '16px',
                                        border: '2px solid #667eea',
                                        borderRadius: '10px',
                                        background: 'white'
                                    }}
                                />
                            ) : (
                                <div style={{
                                    fontSize: '18px',
                                    fontWeight: '600',
                                    color: '#2d3748'
                                }}>
                                    {user.name}
                                </div>
                            )}
                        </div>

                        {/* EMAIL (solo lettura) */}
                        <div>
                            <div style={{fontSize: '13px', color: '#718096', marginBottom: '8px'}}>
                                Email
                            </div>
                            <div style={{
                                fontSize: '16px',
                                color: '#4a5568',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px'
                            }}>
                                üîí {user.email}
                            </div>
                            <div style={{fontSize: '12px', color: '#a0aec0', marginTop: '5px'}}>
                                L'email non pu√≤ essere modificata
                            </div>
                        </div>
                    </div>

                    {/* CARD RUOLI */}
                    <div style={{
                        background: '#f7fafc',
                        borderRadius: '16px',
                        padding: '30px',
                        marginBottom: '20px'
                    }}>
                        <h3 style={{
                            color: '#2d3748',
                            marginBottom: '25px',
                            fontSize: '18px'
                        }}>
                            ‚öΩ Ruoli
                        </h3>

                        {isEditing ? (
                            <>
                                <div style={{marginBottom: '25px'}}>
                                    <label style={{
                                        display: 'block',
                                        fontWeight: '600',
                                        marginBottom: '10px',
                                        color: '#4a5568',
                                        fontSize: '14px'
                                    }}>
                                        Ruolo preferito *
                                    </label>
                                    <select 
                                        value={editPreferredRole} 
                                        onChange={(e) => {
                                            setEditPreferredRole(e.target.value);
                                            setEditOtherRoles(editOtherRoles.filter(r => r !== e.target.value));
                                        }}
                                        style={{
                                            width: '100%',
                                            padding: '12px',
                                            borderRadius: '10px',
                                            border: '2px solid #e2e8f0',
                                            fontSize: '16px',
                                            background: 'white'
                                        }}
                                    >
                                        <option value="">-- Seleziona --</option>
                                        {ROLES.map(role => <option key={role} value={role}>{role}</option>)}
                                    </select>
                                </div>

                                <div>
                                    <label style={{
                                        display: 'block',
                                        fontWeight: '600',
                                        marginBottom: '10px',
                                        color: '#4a5568',
                                        fontSize: '14px'
                                    }}>
                                        Altri ruoli (min. 2) *
                                    </label>
                                    <div style={{
                                        display: 'flex',
                                        flexWrap: 'wrap',
                                        gap: '10px'
                                    }}>
                                        {availableOtherRoles.map(role => (
                                            <button
                                                key={role}
                                                type="button"
                                                onClick={() => handleOtherRoleToggle(role)}
                                                style={{
                                                    padding: '8px 16px',
                                                    borderRadius: '20px',
                                                    border: editOtherRoles.includes(role) ? '2px solid #667eea' : '2px solid #e2e8f0',
                                                    background: editOtherRoles.includes(role) ? '#667eea' : 'white',
                                                    color: editOtherRoles.includes(role) ? 'white' : '#4a5568',
                                                    cursor: 'pointer',
                                                    fontSize: '14px',
                                                    fontWeight: '500',
                                                    transition: 'all 0.2s'
                                                }}
                                            >
                                                {editOtherRoles.includes(role) && '‚úì '}{role}
                                            </button>
                                        ))}
                                    </div>
                                    <div style={{
                                        marginTop: '10px',
                                        fontSize: '13px',
                                        color: editOtherRoles.length >= 2 ? '#48bb78' : '#e53e3e'
                                    }}>
                                        {editOtherRoles.length}/2 ruoli selezionati {editOtherRoles.length >= 2 && '‚úì'}
                                    </div>
                                </div>
                            </>
                        ) : (
                            <>
                                <div style={{
                                    marginBottom: '20px',
                                    paddingBottom: '20px',
                                    borderBottom: '1px solid #e2e8f0'
                                }}>
                                    <div style={{fontSize: '13px', color: '#718096', marginBottom: '8px'}}>
                                        Ruolo preferito
                                    </div>
                                    {user.preferredRole ? (
                                        <div style={{
                                            fontSize: '16px',
                                            fontWeight: '600',
                                            background: 'linear-gradient(135deg, #667eea, #764ba2)',
                                            color: 'white',
                                            padding: '8px 16px',
                                            borderRadius: '20px',
                                            display: 'inline-block'
                                        }}>
                                            {user.preferredRole}
                                        </div>
                                    ) : (
                                        <span style={{color: '#a0aec0', fontStyle: 'italic'}}>Non impostato</span>
                                    )}
                                </div>

                                <div>
                                    <div style={{fontSize: '13px', color: '#718096', marginBottom: '8px'}}>
                                        Mi adatto anche a
                                    </div>
                                    {user.otherRoles && user.otherRoles.length > 0 ? (
                                        <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px'}}>
                                            {user.otherRoles.map(role => (
                                                <span key={role} style={{
                                                    background: '#e2e8f0',
                                                    color: '#4a5568',
                                                    padding: '6px 14px',
                                                    borderRadius: '15px',
                                                    fontSize: '14px',
                                                    fontWeight: '500'
                                                }}>
                                                    {role}
                                                </span>
                                            ))}
                                        </div>
                                    ) : (
                                        <span style={{color: '#a0aec0', fontStyle: 'italic'}}>Nessuno</span>
                                    )}
                                </div>
                            </>
                        )}
                    </div>

                    {/* PULSANTI SALVA/ANNULLA */}
                    {isEditing && (
                        <div style={{
                            display: 'flex',
                            gap: '15px',
                            justifyContent: 'center',
                            marginTop: '30px'
                        }}>
                            <button 
                                onClick={handleCancel}
                                style={{
                                    padding: '14px 35px',
                                    borderRadius: '10px',
                                    border: '2px solid #e2e8f0',
                                    background: 'white',
                                    color: '#4a5568',
                                    fontSize: '16px',
                                    fontWeight: '600',
                                    cursor: 'pointer'
                                }}
                            >
                                ‚úï Annulla
                            </button>
                            <button 
                                onClick={handleSave}
                                disabled={saving}
                                style={{
                                    padding: '14px 35px',
                                    borderRadius: '10px',
                                    border: 'none',
                                    background: 'linear-gradient(135deg, #48bb78, #38a169)',
                                    color: 'white',
                                    fontSize: '16px',
                                    fontWeight: '600',
                                    cursor: saving ? 'wait' : 'pointer',
                                    opacity: saving ? 0.7 : 1
                                }}
                            >
                                {saving ? '‚è≥ Salvataggio...' : '‚úì Salva modifiche'}
                            </button>
                        </div>
                    )}
                </div>
            );
        }
/* ============================================================================
   SEZIONE 13B: COMPONENTE CSV IMPORT MODAL
   ============================================================================ */

        function CSVImportModal({ onClose, onSuccess }) {
            const [votesFile, setVotesFile] = useState(null);
            const [error, setError] = useState('');
            const [importing, setImporting] = useState(false);

            const parseCSV = (text) => {
                const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    const values = line.split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] !== undefined ? values[index].trim() : '';
                    });
                    data.push(row);
                }
                return { headers, data };
            };

            const handleImport = async () => {
                setError('');
                setImporting(true);
                try {
                    if (votesFile) {
                        const text = await votesFile.text();
                        const { data } = parseCSV(text);
                        
                        for (const row of data) {
                            const vote = {
                                voterId: row.voterId || `seed_csv_${Date.now()}_${Math.random()}`,
                                playerId: row.playerId,
                                ratings: {
                                    'Tiro': parseInt(row.tiro || row.Tiro) || 0,
                                    'Passaggio corto': parseInt(row.passaggio_corto || row['Passaggio corto']) || 0,
                                    'Passaggio lungo': parseInt(row.passaggio_lungo || row['Passaggio lungo']) || 0,
                                    'Contrasto': parseInt(row.contrasto || row.Contrasto) || 0,
                                    'Controllo': parseInt(row.controllo || row.Controllo) || 0,
                                    'Visione di gioco': parseInt(row.visione_di_gioco || row['Visione di gioco']) || 0,
                                    'Senso della posizione': parseInt(row.senso_della_posizione || row['Senso della posizione']) || 0,
                                    'Spirito di sacrificio': parseInt(row.spirito_di_sacrificio || row['Spirito di sacrificio']) || 0,
                                    'Letture difensive': parseInt(row.letture_difensive || row['Letture difensive']) || 0,
                                    'Costruzione': parseInt(row.costruzione || row.Costruzione) || 0,
                                    'Resistenza': parseInt(row.resistenza || row.Resistenza) || 0,
                                    'Scatto': parseInt(row.scatto || row.Scatto) || 0,
                                    'Progressione': parseInt(row.progressione || row.Progressione) || 0,
                                    'Presenza fisica': parseInt(row.presenza_fisica || row['Presenza fisica']) || 0,
                                    'Cazzimma': parseInt(row.cazzimma || row.Cazzimma) || 0
                                },
                                timestamp: Date.now()
                            };
                            
                            await storage.addVote(vote);
                        }
                        
                        onSuccess();
                    }
                } catch (e) {
                    console.error(e);
                    setError('Errore nel parsing del file: ' + e.message);
                }
                setImporting(false);
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h2>üìÅ Importa CSV</h2>
                        <p>Carica un file CSV con le valutazioni</p>

                        <div className="form-group">
                            <label>File Valutazioni (CSV)</label>
                            <input type="file" accept=".csv" onChange={(e) => setVotesFile(e.target.files[0])} style={{width: '100%', padding: '10px'}} />
                        </div>

                        {error && <div style={{color: '#e53e3e', marginBottom: '15px'}}>{error}</div>}

                        <div style={{display: 'flex', gap: '15px', marginTop: '20px'}}>
                            <button className="btn btn-secondary" onClick={onClose} style={{flex: 1}}>Annulla</button>
                            <button className="btn btn-primary" onClick={handleImport} style={{flex: 1}} disabled={!votesFile || importing}>
                                {importing ? 'Importazione...' : 'Importa'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }
		
/* ============================================================================
   SEZIONE 14: COMPONENTE ADMIN PAGE
   ============================================================================
   Pannello amministratore - visibile solo all'admin
   ========================================================================== */

        function AdminPage({ users, setUsers, votes, setVotes }) {
            const [editingPlayer, setEditingPlayer] = useState(null);
            const [editName, setEditName] = useState('');
            const [showSuccess, setShowSuccess] = useState(false);
            const [successMessage, setSuccessMessage] = useState('');
            const [editingVotes, setEditingVotes] = useState(null);
            const [voteValues, setVoteValues] = useState({});
            const [showImport, setShowImport] = useState(false);

            const showSuccessMsg = (msg) => {
                setSuccessMessage(msg);
                setShowSuccess(true);
                setTimeout(() => setShowSuccess(false), 3000);
            };

            const handleEditName = (player) => {
                setEditingPlayer(player.id);
                setEditName(player.name);
            };

            const handleSaveName = async (playerId) => {
                if (!editName.trim()) return;
                const updatedUser = users.find(u => u.id === playerId);
                updatedUser.name = editName.trim();
                await storage.updateUser(updatedUser);
                const updatedUsers = users.map(u => u.id === playerId ? updatedUser : u);
                setUsers(updatedUsers);
                setEditingPlayer(null);
                setEditName('');
                showSuccessMsg('Nome aggiornato!');
            };

            const handleDeletePlayer = async (playerId) => {
                if (!confirm('Eliminare questo giocatore e tutte le sue valutazioni?')) return;
                const updatedUsers = users.filter(u => u.id !== playerId);
                setUsers(updatedUsers);
                await storage.setUsers(updatedUsers);
                showSuccessMsg('Giocatore eliminato!');
            };

            const handleEditVotes = (player) => {
                const averages = utils.calculateAverages(player.id, votes);
                if (averages) {
                    const values = {};
                    Object.keys(averages).forEach(k => { values[k] = averages[k].toFixed(2); });
                    setVoteValues(values);
                } else {
                    const emptyValues = {};
                    [...SKILLS.tecniche, ...SKILLS.tattiche, ...SKILLS.fisiche].forEach(skill => { emptyValues[skill] = ''; });
                    setVoteValues(emptyValues);
                }
                setEditingVotes(player);
            };

            const handleSaveVotes = async () => {
                // 1. Elimina tutti i voti seed esistenti per questo giocatore
                const snapshot = await db.collection('votes')
                    .where('playerId', '==', editingVotes.id)
                    .get();
                
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    // Elimina solo i voti seed (non quelli reali degli utenti)
                    if (doc.data().voterId && doc.data().voterId.startsWith('seed')) {
                        batch.delete(doc.ref);
                    }
                });
                await batch.commit();

                // 2. Aggiungi i nuovi voti seed
                for (let i = 0; i < 8; i++) {
                    const seedVote = { 
                        voterId: `seed_admin_${i}_${Date.now()}`, 
                        playerId: editingVotes.id, 
                        ratings: {}, 
                        timestamp: Date.now() 
                    };
                    [...SKILLS.tecniche, ...SKILLS.tattiche, ...SKILLS.fisiche].forEach(skill => {
                        const value = parseFloat(voteValues[skill]);
                        if (!isNaN(value)) seedVote.ratings[skill] = value;
                    });
                    await storage.addVote(seedVote);
                }

                setEditingVotes(null);
                setVoteValues({});
                showSuccessMsg('Valutazioni aggiornate!');
                setTimeout(() => window.location.reload(), 1000);
            };

            const handleResetVotes = (playerId) => {
                if (!confirm('Eliminare tutte le valutazioni di questo giocatore?')) return;
                showSuccessMsg('Funzione non disponibile con Firestore. Elimina manualmente dalla console Firebase.');
            };

            const handleAddPlayer = async () => {
                const newName = prompt('Nome del nuovo giocatore:');
                if (!newName || !newName.trim()) return;
                const newPlayer = { 
                    id: `player${users.length + 1}`, 
                    name: newName.trim(), 
                    avatar: null, 
                    preferredRole: null, 
                    otherRoles: [], 
                    email: null, 
                    claimed: false, 
                    isAdmin: false,
                    isInitialPlayer: false,
                    hasVotedOffline: false
                };
                await storage.updateUser(newPlayer);
                setUsers([...users, newPlayer]);
                showSuccessMsg('Giocatore aggiunto!');
            };

            const handleFullReset = () => {
                if (!confirm('‚ö†Ô∏è ATTENZIONE: Eliminare TUTTI i dati?')) return;
                if (!confirm('Conferma: vuoi davvero cancellare tutto?')) return;
                storage.clearAll();
                window.location.reload();
            };

            return (
                <div style={{maxWidth: '900px', margin: '0 auto'}}>
                    <h2 style={{marginBottom: '30px', color: '#e53e3e'}}>üîß Pannello Amministratore</h2>

                    {showSuccess && <div className="success-message" style={{marginBottom: '20px'}}>‚úì {successMessage}</div>}

                    <div className="settings-group">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                            <h3>üë• Gestione Giocatori ({users.filter(u => !u.id.startsWith('seed')).length})</h3>
                            <button className="btn btn-primary" onClick={handleAddPlayer}>+ Aggiungi</button>
                        </div>
                        
                        <div style={{background: '#f7fafc', borderRadius: '10px', overflow: 'hidden'}}>
                            {users.filter(u => !u.id.startsWith('seed')).map((player, index) => {
                                const voteCount = utils.countVotes(player.id, votes);
                                const averages = utils.calculateAverages(player.id, votes);
                                const overall = utils.calculateOverall(averages);
                                
                                return (
                                    <div key={player.id} style={{padding: '15px 20px', borderBottom: '1px solid #e2e8f0', display: 'flex', alignItems: 'center', gap: '15px'}}>
                                        <span style={{color: '#a0aec0', width: '25px'}}>{index + 1}.</span>
                                        
                                        {editingPlayer === player.id ? (
                                            <div style={{display: 'flex', gap: '10px', flex: 1}}>
                                                <input type="text" value={editName} onChange={(e) => setEditName(e.target.value)} style={{flex: 1, padding: '8px', borderRadius: '6px', border: '2px solid #667eea'}} autoFocus />
                                                <button onClick={() => handleSaveName(player.id)} style={{padding: '8px 16px', background: '#48bb78', color: 'white', border: 'none', borderRadius: '6px', cursor: 'pointer'}}>‚úì</button>
                                                <button onClick={() => setEditingPlayer(null)} style={{padding: '8px 16px', background: '#e2e8f0', border: 'none', borderRadius: '6px', cursor: 'pointer'}}>‚úï</button>
                                            </div>
                                        ) : (
                                            <>
                                                <span style={{fontWeight: '600', minWidth: '140px'}}>{player.name}</span>
                                                <span style={{color: '#718096', fontSize: '13px', flex: 1}}>{player.claimed ? `‚úì ${player.email}` : '‚óØ Non reclamato'}</span>
                                                <span style={{color: '#667eea', fontSize: '13px'}}>OVR: {overall ? utils.toBase10(overall).toFixed(2) : '-'} ({voteCount} voti)</span>
                                                <div style={{display: 'flex', gap: '6px'}}>
                                                    <button onClick={() => handleEditName(player)} style={{padding: '5px 10px', background: '#667eea', color: 'white', border: 'none', borderRadius: '5px', cursor: 'pointer', fontSize: '11px'}}>‚úèÔ∏è</button>
                                                    <button onClick={() => handleEditVotes(player)} style={{padding: '5px 10px', background: '#48bb78', color: 'white', border: 'none', borderRadius: '5px', cursor: 'pointer', fontSize: '11px'}}>üìä</button>
                                                    <button onClick={() => handleResetVotes(player.id)} style={{padding: '5px 10px', background: '#ed8936', color: 'white', border: 'none', borderRadius: '5px', cursor: 'pointer', fontSize: '11px'}}>üîÑ</button>
                                                    <button onClick={() => handleDeletePlayer(player.id)} style={{padding: '5px 10px', background: '#fc8181', color: 'white', border: 'none', borderRadius: '5px', cursor: 'pointer', fontSize: '11px'}}>üóëÔ∏è</button>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    
                    <div className="settings-group" style={{marginTop: '40px'}}>
                        <h3>üìä Importa Dati</h3>
                        <div style={{background: '#f7fafc', padding: '20px', borderRadius: '10px'}}>
                            <p style={{color: '#718096', marginBottom: '15px'}}>Importa valutazioni da file CSV</p>
                            <button className="btn btn-primary" onClick={() => setShowImport(true)}>üìÇ Importa CSV</button>
                        </div>
                    </div>

                    {showImport && (
                        <CSVImportModal 
                            onClose={() => setShowImport(false)}
                            onSuccess={() => { setShowImport(false); showSuccessMsg('Dati importati!'); setTimeout(() => window.location.reload(), 1000); }}
                        />
                    )}

                    <div className="settings-group" style={{marginTop: '40px'}}>
                        <h3 style={{color: '#e53e3e'}}>‚ö†Ô∏è Zona Pericolosa</h3>
                        <div style={{background: '#fff5f5', padding: '20px', borderRadius: '10px', border: '2px solid #fc8181'}}>
                            <p style={{color: '#c53030', marginBottom: '15px'}}>Azioni irreversibili!</p>
                            <button className="btn" onClick={handleFullReset} style={{background: '#e53e3e', color: 'white'}}>üóëÔ∏è Reset Completo</button>
                        </div>
                    </div>

                    {editingVotes && (
                        <div className="modal-overlay">
                            <div className="modal-content" style={{maxWidth: '700px'}}>
                                <h2>üìä Modifica: {editingVotes.name}</h2>
                                <p>Inserisci valori 1-4. Verranno creati 8 voti seed.</p>
                                {['tecniche', 'tattiche', 'fisiche'].map(category => (
                                    <div key={category} style={{marginBottom: '20px'}}>
                                        <h4 style={{color: category === 'tecniche' ? '#667eea' : category === 'tattiche' ? '#48bb78' : '#f56565', marginBottom: '10px', textTransform: 'capitalize'}}>{category}</h4>
                                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '8px'}}>
                                            {SKILLS[category].map(skill => (
                                                <div key={skill} style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                                    <label style={{flex: 1, fontSize: '13px'}}>{skill}</label>
                                                    <input type="number" min="1" max="4" step="0.01" value={voteValues[skill] || ''} onChange={(e) => setVoteValues({...voteValues, [skill]: e.target.value})} style={{width: '70px', padding: '6px', borderRadius: '5px', border: '2px solid #e2e8f0', textAlign: 'center'}} />
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                                <div style={{display: 'flex', gap: '15px', marginTop: '20px'}}>
                                    <button className="btn btn-secondary" onClick={() => {setEditingVotes(null); setVoteValues({});}} style={{flex: 1}}>Annulla</button>
                                    <button className="btn btn-primary" onClick={handleSaveVotes} style={{flex: 1}}>Salva</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
/* ============================================================================
   SEZIONE 14B: COMPONENTE DEBUG PAGE
   ============================================================================
   Pannello di debugging per verificare voti e calcoli
   ========================================================================== */

        function DebugPage({ users, votes }) {
            const [selectedPlayer, setSelectedPlayer] = useState(null);

            const getVoteStats = (playerId) => {
                const playerVotes = votes.filter(v => v.playerId === playerId);
                const seedVotes = playerVotes.filter(v => v.voterId && v.voterId.startsWith('seed'));
                const realVotes = playerVotes.filter(v => v.voterId && !v.voterId.startsWith('seed'));
                
                return {
                    total: playerVotes.length,
                    seed: seedVotes.length,
                    real: realVotes.length,
                    allVotes: playerVotes
                };
            };

            const players = users.filter(u => !u.id.startsWith('seed'));

            const renderPlayerDetail = (player) => {
                const stats = getVoteStats(player.id);
                const averages = utils.calculateAverages(player.id, votes);
                const overall = utils.calculateOverall(averages);

                return (
                    <div style={{
                        background: 'white',
                        borderRadius: '12px',
                        padding: '30px',
                        marginTop: '20px'
                    }}>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '30px'}}>
                            <h2 style={{margin: 0, color: '#2d3748'}}>
                                üìä Dettaglio: {player.name}
                            </h2>
                            <button 
                                onClick={() => setSelectedPlayer(null)}
                                style={{
                                    padding: '8px 16px',
                                    background: '#e2e8f0',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: 'pointer'
                                }}
                            >
                                ‚Üê Indietro
                            </button>
                        </div>

                        {/* Riepilogo */}
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(4, 1fr)',
                            gap: '15px',
                            marginBottom: '30px'
                        }}>
                            <div style={{background: '#f7fafc', padding: '15px', borderRadius: '8px', textAlign: 'center'}}>
                                <div style={{fontSize: '24px', fontWeight: '700', color: '#667eea'}}>
                                    {stats.seed}
                                </div>
                                <div style={{fontSize: '12px', color: '#718096'}}>Voti Seed</div>
                            </div>
                            <div style={{background: '#f7fafc', padding: '15px', borderRadius: '8px', textAlign: 'center'}}>
                                <div style={{fontSize: '24px', fontWeight: '700', color: '#48bb78'}}>
                                    {stats.real}
                                </div>
                                <div style={{fontSize: '12px', color: '#718096'}}>Voti Reali</div>
                            </div>
                            <div style={{background: '#f7fafc', padding: '15px', borderRadius: '8px', textAlign: 'center'}}>
                                <div style={{fontSize: '24px', fontWeight: '700', color: '#2d3748'}}>
                                    {stats.total}
                                </div>
                                <div style={{fontSize: '12px', color: '#718096'}}>Totale</div>
                            </div>
                            <div style={{background: '#f7fafc', padding: '15px', borderRadius: '8px', textAlign: 'center'}}>
                                <div style={{fontSize: '24px', fontWeight: '700', color: '#f56565'}}>
                                    {overall ? utils.toBase10(overall).toFixed(2) : '-'}
                                </div>
                                <div style={{fontSize: '12px', color: '#718096'}}>Overall</div>
                            </div>
                        </div>

                        {/* Tabella voti dettagliata */}
                        <h3 style={{marginBottom: '15px', color: '#2d3748'}}>üó≥Ô∏è Tutti i Voti</h3>
                        <div style={{overflowX: 'auto'}}>
                            <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '12px'}}>
                                <thead>
                                    <tr style={{background: '#2d3748', color: 'white'}}>
                                        <th style={{padding: '10px', textAlign: 'left', position: 'sticky', left: 0, background: '#2d3748'}}>Votante</th>
                                        <th style={{padding: '10px', textAlign: 'center'}}>Tipo</th>
                                        {/* Tecniche */}
                                        <th style={{padding: '10px', textAlign: 'center', background: '#667eea'}}>Tiro</th>
                                        <th style={{padding: '10px', textAlign: 'center', background: '#667eea'}}>Pass.C</th>
                                        <th style={{padding: '10px', textAlign: 'center', background: '#667eea'}}>Pass.L</th>
                                        <th style={{padding: '10px', textAlign: 'center', background: '#667eea'}}>Contr.</th>
                                        <th style={{padding: '10px', textAlign: 'center', background: '#667eea'}}>Control.</th>
                                        {/* Tattiche */}
                                        <th style={{padding: '10px', textAlign: 'center', background: '#48bb78'}}>Vision</th>
                                        <th style={{padding: '10px', textAlign: 'center', background: '#48bb78'}}>Posiz.</th>
                                        <th style={{padding: '10px', textAlign: 'center', background: '#48bb78'}}>Sacrif.</th>
                                        <th style={{padding: '10px', textAlign: 'center', background: '#48bb78'}}>Lett.Dif</th>
                                        <th style={{padding: '10px', textAlign: 'center', background: '#48bb78'}}>Costr.</th>
                                        {/* Fisiche */}
                                        <th style={{padding: '10px', textAlign: 'center', background: '#f56565'}}>Resist.</th>
                                        <th style={{padding: '10px', textAlign: 'center', background: '#f56565'}}>Scatto</th>
                                        <th style={{padding: '10px', textAlign: 'center', background: '#f56565'}}>Progr.</th>
                                        <th style={{padding: '10px', textAlign: 'center', background: '#f56565'}}>Pres.Fis</th>
                                        <th style={{padding: '10px', textAlign: 'center', background: '#f56565'}}>Cazzim.</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {stats.allVotes.map((vote, index) => {
                                        const isSeed = vote.voterId.startsWith('seed');
                                        const voterName = isSeed ? 'ü§ñ Seed' : (users.find(u => u.id === vote.voterId)?.name || 'Sconosciuto');
                                        
                                        return (
                                            <tr key={index} style={{
                                                background: index % 2 === 0 ? '#f7fafc' : 'white',
                                                borderBottom: '1px solid #e2e8f0'
                                            }}>
                                                <td style={{padding: '8px', position: 'sticky', left: 0, background: index % 2 === 0 ? '#f7fafc' : 'white'}}>{voterName}</td>
                                                <td style={{padding: '8px', textAlign: 'center'}}>
                                                    <span style={{
                                                        background: isSeed ? '#667eea' : '#48bb78',
                                                        color: 'white',
                                                        padding: '2px 6px',
                                                        borderRadius: '8px',
                                                        fontSize: '10px'
                                                    }}>
                                                        {isSeed ? 'Seed' : 'Reale'}
                                                    </span>
                                                </td>
                                                {/* Tecniche */}
                                                <td style={{padding: '8px', textAlign: 'center', fontWeight: '600'}}>{vote.ratings['Tiro'] || '-'}</td>
                                                <td style={{padding: '8px', textAlign: 'center', fontWeight: '600'}}>{vote.ratings['Passaggio corto'] || '-'}</td>
                                                <td style={{padding: '8px', textAlign: 'center', fontWeight: '600'}}>{vote.ratings['Passaggio lungo'] || '-'}</td>
                                                <td style={{padding: '8px', textAlign: 'center', fontWeight: '600'}}>{vote.ratings['Contrasto'] || '-'}</td>
                                                <td style={{padding: '8px', textAlign: 'center', fontWeight: '600'}}>{vote.ratings['Controllo'] || '-'}</td>
                                                {/* Tattiche */}
                                                <td style={{padding: '8px', textAlign: 'center', fontWeight: '600'}}>{vote.ratings['Visione di gioco'] || '-'}</td>
                                                <td style={{padding: '8px', textAlign: 'center', fontWeight: '600'}}>{vote.ratings['Senso della posizione'] || '-'}</td>
                                                <td style={{padding: '8px', textAlign: 'center', fontWeight: '600'}}>{vote.ratings['Spirito di sacrificio'] || '-'}</td>
                                                <td style={{padding: '8px', textAlign: 'center', fontWeight: '600'}}>{vote.ratings['Letture difensive'] || '-'}</td>
                                                <td style={{padding: '8px', textAlign: 'center', fontWeight: '600'}}>{vote.ratings['Costruzione'] || '-'}</td>
                                                {/* Fisiche */}
                                                <td style={{padding: '8px', textAlign: 'center', fontWeight: '600'}}>{vote.ratings['Resistenza'] || '-'}</td>
                                                <td style={{padding: '8px', textAlign: 'center', fontWeight: '600'}}>{vote.ratings['Scatto'] || '-'}</td>
                                                <td style={{padding: '8px', textAlign: 'center', fontWeight: '600'}}>{vote.ratings['Progressione'] || '-'}</td>
                                                <td style={{padding: '8px', textAlign: 'center', fontWeight: '600'}}>{vote.ratings['Presenza fisica'] || '-'}</td>
                                                <td style={{padding: '8px', textAlign: 'center', fontWeight: '600'}}>{vote.ratings['Cazzimma'] || '-'}</td>
                                            </tr>
                                        );
                                    })}
                                    {/* RIGA MEDIE */}
                                    <tr style={{background: '#2d3748', color: 'white', fontWeight: '700'}}>
                                        <td style={{padding: '10px', position: 'sticky', left: 0, background: '#2d3748'}}>üìä MEDIA FINALE</td>
                                        <td style={{padding: '10px'}}></td>
                                        {[...SKILLS.tecniche, ...SKILLS.tattiche, ...SKILLS.fisiche].map(skill => {
                                            const skillVotes = stats.allVotes.map(v => v.ratings[skill]).filter(v => v !== undefined);
                                            const avg = skillVotes.length > 0 ? skillVotes.reduce((a, b) => a + b, 0) / skillVotes.length : 0;
                                            return (
                                                <td key={skill} style={{
                                                    padding: '10px',
                                                    textAlign: 'center',
                                                    fontSize: '14px',
                                                    color: '#ffd700'
                                                }}>
                                                    {avg > 0 ? `${avg.toFixed(2)} (${utils.toBase10(avg).toFixed(2)})` : '-'}
                                                </td>
                                            );
                                        })}
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        {/* Medie per skill */}
                        {averages && (
                            <div style={{marginTop: '30px'}}>
                                <h3 style={{marginBottom: '15px', color: '#2d3748'}}>üìà Calcolo Medie per Skill</h3>
                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '20px'}}>
                                    {Object.entries(SKILLS).map(([category, skills]) => (
                                        <div key={category} style={{background: '#f7fafc', borderRadius: '10px', padding: '15px'}}>
                                            <h4 style={{
                                                color: category === 'tecniche' ? '#667eea' : category === 'tattiche' ? '#48bb78' : '#f56565',
                                                marginBottom: '10px',
                                                textTransform: 'capitalize'
                                            }}>
                                                {category}
                                            </h4>
                                            {skills.map(skill => {
                                                const skillVotes = stats.allVotes.map(v => v.ratings[skill]).filter(v => v !== undefined);
                                                const avg = skillVotes.reduce((a, b) => a + b, 0) / skillVotes.length;
                                                
                                                return (
                                                    <div key={skill} style={{
                                                        marginBottom: '8px',
                                                        fontSize: '12px'
                                                    }}>
                                                        <div style={{fontWeight: '600', color: '#4a5568'}}>{skill}</div>
                                                        <div style={{color: '#718096', marginTop: '2px'}}>
                                                            Voti: {skillVotes.join(', ')} = <span style={{fontWeight: '700', color: '#2d3748'}}>
                                                                Media: {avg.toFixed(2)} ‚Üí {utils.toBase10(avg).toFixed(2)}/10
                                                            </span>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            if (selectedPlayer) {
                const player = players.find(p => p.id === selectedPlayer);
                return renderPlayerDetail(player);
            }

            return (
                <div style={{maxWidth: '1200px', margin: '0 auto'}}>
                    <h2 style={{marginBottom: '30px', color: '#2d3748'}}>üêõ Debug - Riepilogo Voti</h2>

                    <div style={{
                        background: '#f7fafc',
                        borderRadius: '12px',
                        padding: '20px',
                        marginBottom: '30px'
                    }}>
                        <h3 style={{marginBottom: '20px'}}>üìä Statistiche Globali</h3>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '20px'}}>
                            <div style={{background: 'white', padding: '20px', borderRadius: '10px', textAlign: 'center'}}>
                                <div style={{fontSize: '36px', fontWeight: '700', color: '#667eea'}}>
                                    {votes.filter(v => v.voterId && v.voterId.startsWith('seed')).length}
                                </div>
                                <div style={{color: '#718096', marginTop: '5px'}}>Voti Seed Totali</div>
                            </div>
                            <div style={{background: 'white', padding: '20px', borderRadius: '10px', textAlign: 'center'}}>
                                <div style={{fontSize: '36px', fontWeight: '700', color: '#48bb78'}}>
                                    {votes.filter(v => v.voterId && !v.voterId.startsWith('seed')).length}
                                </div>
                                <div style={{color: '#718096', marginTop: '5px'}}>Voti Reali Totali</div>
                            </div>
                            <div style={{background: 'white', padding: '20px', borderRadius: '10px', textAlign: 'center'}}>
                                <div style={{fontSize: '36px', fontWeight: '700', color: '#f56565'}}>
                                    {votes.length}
                                </div>
                                <div style={{color: '#718096', marginTop: '5px'}}>Voti Totali</div>
                            </div>
                        </div>
                    </div>

                    <div style={{
                        background: '#f7fafc',
                        borderRadius: '12px',
                        padding: '20px'
                    }}>
                        <h3 style={{marginBottom: '20px'}}>üë• Dettaglio per Giocatore</h3>
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: '2fr 1fr 1fr 1fr 1fr 100px',
                            gap: '10px',
                            padding: '15px',
                            background: '#2d3748',
                            color: 'white',
                            borderRadius: '8px',
                            fontWeight: '600',
                            marginBottom: '10px'
                        }}>
                            <div>Giocatore</div>
                            <div style={{textAlign: 'center'}}>Voti Seed</div>
                            <div style={{textAlign: 'center'}}>Voti Reali</div>
                            <div style={{textAlign: 'center'}}>Totale</div>
                            <div style={{textAlign: 'center'}}>Overall</div>
                            <div style={{textAlign: 'center'}}>Azioni</div>
                        </div>

                        {players.map(player => {
                            const stats = getVoteStats(player.id);
                            const averages = utils.calculateAverages(player.id, votes);
                            const overall = utils.calculateOverall(averages);
                            
                            return (
                                <div 
                                    key={player.id}
                                    style={{
                                        display: 'grid',
                                        gridTemplateColumns: '2fr 1fr 1fr 1fr 1fr 100px',
                                        gap: '10px',
                                        padding: '15px',
                                        background: 'white',
                                        borderRadius: '8px',
                                        marginBottom: '8px',
                                        alignItems: 'center'
                                    }}
                                >
                                    <div style={{fontWeight: '600', color: '#2d3748'}}>
                                        {player.name}
                                        <span style={{color: '#a0aec0', fontSize: '12px', marginLeft: '8px'}}>
                                            ({player.id})
                                        </span>
                                    </div>
                                    <div style={{
                                        textAlign: 'center',
                                        color: '#667eea',
                                        fontWeight: '600',
                                        fontSize: '18px'
                                    }}>
                                        {stats.seed}
                                    </div>
                                    <div style={{
                                        textAlign: 'center',
                                        color: '#48bb78',
                                        fontWeight: '600',
                                        fontSize: '18px'
                                    }}>
                                        {stats.real}
                                    </div>
                                    <div style={{
                                        textAlign: 'center',
                                        color: '#2d3748',
                                        fontWeight: '700',
                                        fontSize: '20px'
                                    }}>
                                        {stats.total}
                                    </div>
                                    <div style={{
                                        textAlign: 'center',
                                        color: overall ? '#f56565' : '#a0aec0',
                                        fontWeight: '700',
                                        fontSize: '18px'
                                    }}>
                                        {overall ? utils.toBase10(overall).toFixed(2) : '-'}
                                    </div>
                                    <div style={{textAlign: 'center'}}>
                                        <button
                                            onClick={() => setSelectedPlayer(player.id)}
                                            style={{
                                                padding: '6px 12px',
                                                background: '#667eea',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '12px'
                                            }}
                                        >
                                            üîç Dettagli
                                        </button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    <div style={{
                        background: '#fff5f5',
                        border: '2px solid #fc8181',
                        borderRadius: '12px',
                        padding: '20px',
                        marginTop: '30px'
                    }}>
                        <h3 style={{color: '#c53030', marginBottom: '10px'}}>‚ö†Ô∏è Note</h3>
                        <ul style={{color: '#742a2a', lineHeight: '1.8'}}>
                            <li><strong>Voti Seed:</strong> Voti inseriti dall'Admin (dovrebbero essere 8 per giocatore)</li>
                            <li><strong>Voti Reali:</strong> Voti dati da altri utenti dell'app</li>
                            <li><strong>Overall:</strong> Media di tutte le skill (scala 1-10)</li>
                            <li>Clicca su "üîç Dettagli" per vedere tutti i voti e i calcoli delle medie</li>
                        </ul>
                    </div>
                </div>
            );
        }
		
	/* ============================================================================
   SEZIONE 15: COMPONENTE APP (PRINCIPALE)
   ============================================================================
   Gestisce stato globale, autenticazione e navigazione
   ‚ö†Ô∏è ATTENZIONE: Modificare con cautela!
   ========================================================================== */

        function App() {
            // Helper per gestire pendingEmail anche dopo redirect
            const getPendingEmail = () => sessionStorage.getItem('pendingEmail');
            const setPendingEmailStorage = (email) => {
                if (email) {
                    sessionStorage.setItem('pendingEmail', email);
                } else {
                    sessionStorage.removeItem('pendingEmail');
                }
            };

            const [currentUser, setCurrentUser] = useState(storage.getCurrentUser());
            const [activeTab, setActiveTab] = useState('valuta');
            const [selectedPlayer, setSelectedPlayer] = useState(null);
            const [viewingProfile, setViewingProfile] = useState(null);
            const [users, setUsers] = useState([]);
            const [votes, setVotes] = useState([]);
            const [showRoleModal, setShowRoleModal] = useState(false);
            const [showClaimModal, setShowClaimModal] = useState(false);
            const [pendingEmail, setPendingEmail] = useState(getPendingEmail());
            const [loading, setLoading] = useState(true);

            // Carica dati da Firestore all'avvio
            useEffect(() => {
                const loadData = async () => {
                    setLoading(true);
                    try {
                        let loadedUsers = await storage.getUsers();
                        
                        if (loadedUsers.length === 0) {
                            // Se il database √® vuoto, non caricare pi√π INITIAL_PLAYERS
                            // L'admin dovr√† aggiungere manualmente i giocatori
                            loadedUsers = [];
                        }
                        
                        const loadedVotes = await storage.getVotes();
                        
                        setUsers(loadedUsers);
                        setVotes(loadedVotes);
                    } catch (error) {
                        console.error('Errore caricamento dati:', error);
                    }
                    setLoading(false);
                };
                
                loadData();
            }, []);

// Gestisce autenticazione
            useEffect(() => {
                if (loading || currentUser) return;

                const unsubscribe = firebase.auth().onAuthStateChanged((firebaseUser) => {
                    if (firebaseUser && firebaseUser.email) {
                        const email = firebaseUser.email;
                        const existingUser = users.find(u => u.email === email);
                        
                        if (existingUser) {
                            const userWithAdmin = { ...existingUser, isAdmin: email === ADMIN_EMAIL };
                            setCurrentUser(userWithAdmin);
                            storage.setCurrentUser(userWithAdmin);
                            if (!existingUser.preferredRole) setShowRoleModal(true);
                        } else {
                            setPendingEmail(email);
                            setShowClaimModal(true);
                        }
                    }
                });

                return () => unsubscribe();
            }, [loading, users, currentUser]);

            const handleLogin = (email) => {
                const existingUser = users.find(u => u.email === email);
                if (existingUser) {
                    const userWithAdmin = { ...existingUser, isAdmin: email === ADMIN_EMAIL };
                    setCurrentUser(userWithAdmin);
                    storage.setCurrentUser(userWithAdmin);
                    if (!existingUser.preferredRole) setShowRoleModal(true);
                } else {
                    setPendingEmail(email);
                    setPendingEmailStorage(email);
                    setShowClaimModal(true);
                }
            };

            const handleClaimProfile = async (playerId) => {
                const isAdmin = pendingEmail === ADMIN_EMAIL;
                const claimedUser = { ...users.find(u => u.id === playerId), email: pendingEmail, claimed: true, isAdmin };
                
                await storage.updateUser(claimedUser);
                
                const updatedUsers = users.map(u => u.id === playerId ? claimedUser : u);
                setUsers(updatedUsers);
                setCurrentUser(claimedUser);
                storage.setCurrentUser(claimedUser);
                setShowClaimModal(false);
                setPendingEmail(null);
                setPendingEmailStorage(null);
                if (!claimedUser.preferredRole) setShowRoleModal(true);
            };

            const handleNewPlayer = async (playerName) => {
                const isAdmin = pendingEmail === ADMIN_EMAIL;
                const newUser = { 
                    id: `player${users.length + 1}`, 
                    name: playerName || pendingEmail.split('@')[0],
                    email: pendingEmail,
                    avatar: null,
                    preferredRole: null,
                    otherRoles: [],
                    claimed: true,
                    isAdmin: isAdmin,
                    isInitialPlayer: false,
                    hasVotedOffline: false
                };
                
                await storage.updateUser(newUser);
                
                setUsers([...users, newUser]);
                setCurrentUser(newUser);
                storage.setCurrentUser(newUser);
                setShowClaimModal(false);
                setPendingEmail(null);
                setPendingEmailStorage(null);
                setShowRoleModal(true);
            };

            const handleLogout = () => {
                firebase.auth().signOut();
                setCurrentUser(null);
                storage.setCurrentUser(null);
            };

            const handleVoteSubmit = async (playerId, ratings) => {
                const newVote = { 
                    voterId: currentUser.id, 
                    voterName: currentUser.name,
                    voterEmail: currentUser.email,
                    playerId, 
                    ratings, 
                    timestamp: Date.now(),
                    date: new Date().toISOString()
                };
                
                await storage.addVote(newVote);
                
                setVotes([...votes, newVote]);
                setSelectedPlayer(null);
            };

            const handleRolesSave = async (preferredRole, otherRoles) => {
                const updatedCurrentUser = { ...currentUser, preferredRole, otherRoles };
                
                await storage.updateUser(updatedCurrentUser);
                
                const updatedUsers = users.map(u => u.id === currentUser.id ? updatedCurrentUser : u);
                setUsers(updatedUsers);
                setCurrentUser(updatedCurrentUser);
                storage.setCurrentUser(updatedCurrentUser);
                setShowRoleModal(false);
            };

            if (loading) {
                return (
                    <div className="login-container">
                        <div className="login-card">
                            <h1>‚öΩ Calcetto Rating</h1>
                            <p>Caricamento in corso...</p>
                        </div>
                    </div>
                );
            }

            if (!currentUser) {
                return (
                    <>
                        <LoginPage onLogin={handleLogin} />
                        {showClaimModal && <ClaimProfileModal users={users} onClaim={handleClaimProfile} onNewPlayer={handleNewPlayer} />}
                    </>
                );
            }

            return (
                <div className="app-container">
                    {showRoleModal && <RoleSelectionModal onSave={handleRolesSave} />}
                    
                    <Header user={currentUser} onLogout={handleLogout} />
                    
                    <div className="nav-tabs">
                        <button className={`nav-tab ${activeTab === 'valuta' ? 'active' : ''}`} onClick={() => { setActiveTab('valuta'); setSelectedPlayer(null); setViewingProfile(null); }}>‚öΩ Valuta</button>
                        <button className={`nav-tab ${activeTab === 'profilo' ? 'active' : ''}`} onClick={() => { setActiveTab('profilo'); setSelectedPlayer(null); setViewingProfile(null); }}>üë§ Profilo</button>
                        <button className={`nav-tab ${activeTab === 'classifiche' ? 'active' : ''}`} onClick={() => { setActiveTab('classifiche'); setSelectedPlayer(null); setViewingProfile(null); }}>üìä Classifiche</button>
                        <button className={`nav-tab ${activeTab === 'impostazioni' ? 'active' : ''}`} onClick={() => { setActiveTab('impostazioni'); setSelectedPlayer(null); setViewingProfile(null); }}>‚öôÔ∏è Impostazioni</button>
                        {currentUser.isAdmin && <button className={`nav-tab ${activeTab === 'admin' ? 'active' : ''}`} onClick={() => { setActiveTab('admin'); setSelectedPlayer(null); setViewingProfile(null); }} style={{background: activeTab === 'admin' ? 'linear-gradient(135deg, #e53e3e, #c53030)' : ''}}>üîß Admin</button>}
                        {currentUser.isAdmin && <button className={`nav-tab ${activeTab === 'debug' ? 'active' : ''}`} onClick={() => { setActiveTab('debug'); setSelectedPlayer(null); setViewingProfile(null); }} style={{background: activeTab === 'debug' ? 'linear-gradient(135deg, #f56565, #e53e3e)' : ''}}>üêõ Debug</button>}
                    </div>
                    
                    <div className="content">
                        {viewingProfile ? (
                            <div>
                                <button className="btn btn-secondary" onClick={() => setViewingProfile(null)} style={{marginBottom: '20px'}}>‚Üê Indietro</button>
                                <PlayerProfile player={users.find(u => u.id === viewingProfile)} votes={votes} isOwnProfile={viewingProfile === currentUser.id} />
                            </div>
                        ) : selectedPlayer ? (
                            <RatingForm player={users.find(u => u.id === selectedPlayer)} onSubmit={handleVoteSubmit} onCancel={() => setSelectedPlayer(null)} />
                        ) : activeTab === 'valuta' ? (
                            <PlayersListPage users={users} currentUser={currentUser} votes={votes} onSelectPlayer={setSelectedPlayer} />
                        ) : activeTab === 'profilo' ? (
                            <PlayerProfile player={currentUser} votes={votes} isOwnProfile={true} />
                        ) : activeTab === 'classifiche' ? (
                            <ClassifichePage users={users} votes={votes} onViewProfile={setViewingProfile} />
                        ) : activeTab === 'admin' && currentUser.isAdmin ? (
                            <AdminPage users={users} setUsers={setUsers} votes={votes} setVotes={setVotes} />
                        ) : activeTab === 'debug' && currentUser.isAdmin ? (
                            <DebugPage users={users} votes={votes} />
                        ) : (
                            <SettingsPage 
                                user={currentUser} 
                                onUpdateUser={async (updatedUser) => {
                                    await storage.updateUser(updatedUser);
                                    const updatedUsers = users.map(u => u.id === updatedUser.id ? updatedUser : u);
                                    setUsers(updatedUsers);
                                    setCurrentUser(updatedUser);
                                    storage.setCurrentUser(updatedUser);
                                }}
                            />
                        )}
                    </div>
                </div>
            );
        }

        // Avvia l'applicazione
        try {
            ReactDOM.render(<App />, document.getElementById('root'));
        } catch (error) {
            document.getElementById('root').innerHTML = '<div style="color:white;text-align:center;padding:50px;"><h2>Errore caricamento</h2><p>' + error.message + '</p></div>';
        }

    </script>
</body>
</html>
